import{_ as R,b as F}from"./CgIiZEOf.js";import{_ as L}from"./pk_2nDSo.js";import{_ as O}from"./BUEje9Vi.js";import{_ as H}from"./DS44Xi_z.js";import{a as J,_ as K}from"./BG3swkV7.js";import{_ as Q}from"./CSpB-GDR.js";import{_ as W}from"./BNgrYORC.js";import{_ as X}from"./C0cAW4TD.js";import{e as Y,f as Z,a7 as ee,a8 as ae,q as te,G as oe,c as d,a as i,b as o,d as h,t as m,k,w as l,r as y,o as n,m as z,j as se,z as le}from"./iOwrpkly.js";import"./DciJrsg7.js";import"./DlAUqK2U.js";import"./D4b3bMTJ.js";import"./Cx4aQaRX.js";import"./D-_pGzkv.js";const ie={class:"space-y-6"},ne={class:"flex justify-between items-center"},re={key:0,class:"flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800/50 rounded-lg px-4 py-2"},de={class:"text-slate-700 dark:text-white"},me={class:"text-slate-700 dark:text-white"},ce={key:0},ue={key:1,class:"text-xs text-slate-400"},_e={key:1,class:"text-xs text-slate-400"},pe={class:"text-xs font-medium px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300"},fe={key:0,class:"font-medium text-slate-700 dark:text-slate-200"},xe={key:1,class:"text-slate-400"},ye={class:"font-medium text-slate-700 dark:text-slate-200"},ve={class:"font-medium text-slate-700 dark:text-slate-200"},be={class:"flex items-center justify-between"},he={class:"text-base font-semibold text-gray-900 dark:text-white"},ge={key:0,class:"text-sm text-slate-500 mb-2"},ke={class:"font-bold text-slate-900 dark:text-white"},Ve={key:1,class:"space-y-4"},we={key:3,class:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700 space-y-4"},Ue={class:"space-y-2"},Ce={key:0,class:"pl-6"},qe={class:"space-y-3"},Ne={key:0,class:"grid grid-cols-2 gap-4 pl-6"},Se={class:"flex justify-end gap-3 mt-6"},Oe=Y({__name:"index",setup(Ae){const p=Z(),$=ee("headerTitle",()=>"Equipo");$.value="Gestión Rol";const E=ae(),V=y([]),w=y([]),q=y([]),c=y(null),v=y(!1),N=y(!1),f=y(null),u=y(null),e=le({full_name:"",email:"",password:"",role:"stylist",branch_id:"",specialty_id:"",commission_rate:0,product_commission_rate:0,has_fixed_rent:!1,has_commission:!1,fixed_rent_cost:0}),j=[{key:"full_name",label:"Nombre"},{key:"role",label:"Rol"},{key:"specialty_id",label:"Especialidad"},{key:"commission_type",label:"Tipo"},{key:"fixed_rent_cost",label:"Arriendo"},{key:"commission_rate",label:"% Serv"},{key:"product_commission_rate",label:"% Prod"},{key:"branch_id",label:"Sucursal"},{key:"actions",label:""}],G=s=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(s),S=async()=>{let s=E.value?.id;if(!s){const{data:{session:a}}=await p.auth.getSession();a?.user&&(s=a.user.id)}if(s){if(!u.value){const{data:a}=await p.from("profiles").select("tenant_id").eq("id",s).single();a&&(u.value=a.tenant_id)}if(u.value){const{data:a,error:r}=await p.from("profiles").select("*").eq("tenant_id",u.value);r&&console.error("Error fetching team:",r),a&&(V.value=a);const{data:x}=await p.from("branches").select("id, name").eq("tenant_id",u.value).eq("active",!0);x&&(w.value=x);const{data:g}=await p.from("specialties").select("id, name").eq("tenant_id",u.value);if(g&&(q.value=g),!c.value){const{data:U}=await p.from("tenants").select("plan_id, plans ( name, max_users, max_branches )").eq("id",u.value).single();U?.plans&&(c.value=U.plans)}}}};te(E,()=>{S()},{immediate:!0});const B=()=>{if(c.value&&V.value.length>=c.value.max_users){alert(`Has alcanzado el límite de ${c.value.max_users} usuario(s) de tu plan "${c.value.name}". Mejora tu plan para agregar más usuarios.`);return}f.value=null,e.full_name="",e.email="",e.password="",e.role="stylist",e.branch_id="",e.specialty_id="",e.commission_rate=0,e.product_commission_rate=0,e.has_fixed_rent=!1,e.has_commission=!1,e.fixed_rent_cost=0,v.value=!0},P=s=>{f.value=s,e.full_name=s.full_name,e.role=s.role,e.branch_id=s.branch_id||"",e.specialty_id=s.specialty_id||"",e.commission_rate=s.commission_rate||0,e.product_commission_rate=s.product_commission_rate||0,e.has_fixed_rent=s.commission_type==="fixed_rent"||s.commission_type==="both",e.has_commission=s.commission_type==="percentage"||s.commission_type==="both",e.fixed_rent_cost=s.fixed_rent_cost||0,v.value=!0},D=async()=>{if(!u.value){alert("Error: No se ha identificado tu negocio.");return}N.value=!0;try{const s=e.has_fixed_rent&&e.has_commission?"both":e.has_fixed_rent?"fixed_rent":(e.has_commission,"percentage"),a={role:e.role,branch_id:e.branch_id||null,specialty_id:e.specialty_id||null,commission_type:s,commission_rate:e.has_commission?Number(e.commission_rate):0,product_commission_rate:e.has_commission?Number(e.product_commission_rate):0,fixed_rent_cost:e.has_fixed_rent?Number(e.fixed_rent_cost):0};if(f.value){const{data:r,error:x}=await p.from("profiles").update(a).eq("id",f.value.id).select();if(x)throw x;alert("Miembro actualizado correctamente.")}else{const{data:{session:r}}=await p.auth.getSession();if(!r)throw new Error("No hay sesión activa");const x=await $fetch("https://hupbcynenviknhwnhwxb.supabase.co/functions/v1/create-user",{method:"POST",headers:{Authorization:`Bearer ${r.access_token}`,"Content-Type":"application/json"},body:{email:e.email,password:e.password,full_name:e.full_name,tenant_id:u.value,...a}});alert("Usuario creado correctamente")}v.value=!1,await S()}catch(s){alert("Error: "+(s.statusMessage||s.message))}finally{N.value=!1}};return oe(()=>{S()}),(s,a)=>{const r=R,x=F,g=L,U=O,M=H,b=K,_=J,A=Q,T=W,I=X;return n(),d("div",ie,[i("div",ne,[a[14]||(a[14]=i("div",{class:"hidden md:block"},[i("h1",{class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},"Gestión Rol"),i("p",{class:"text-slate-500 dark:text-slate-400 mt-1"},"Configura roles, permisos y esquemas de comisiones.")],-1)),o(r,{label:"Nuevo Usuario",icon:"i-heroicons-user-plus",color:"emerald",size:"lg",onClick:B,class:"shadow-lg shadow-emerald-500/20"})]),c.value?(n(),d("div",re,[o(x,{name:"i-heroicons-information-circle",class:"w-5 h-5 text-emerald-500"}),i("span",null,[a[15]||(a[15]=h("Usuarios activos: ",-1)),i("strong",de,m(V.value.length),1),a[16]||(a[16]=h(" / ",-1)),i("strong",me,m(c.value.max_users),1),h(" ("+m(c.value.name)+")",1)])])):k("",!0),o(M,{ui:{body:{padding:"p-0"}}},{default:l(()=>[o(U,{rows:V.value,columns:j,ui:{thead:"bg-slate-50 dark:bg-slate-800/50",th:{color:"text-slate-900 dark:text-white"},td:{color:"text-slate-600 dark:text-slate-400"}}},{"role-data":l(({row:t})=>[o(g,{color:t.role==="admin"?"purple":"blue",variant:"subtle"},{default:l(()=>[h(m(t.role==="admin"?"Administrador":"Usuario"),1)]),_:2},1032,["color"])]),"branch_id-data":l(({row:t})=>[w.value.length>0?(n(),d("span",ce,m(w.value.find(C=>C.id===t.branch_id)?.name||"Sin Asignar"),1)):(n(),d("span",ue,"Cargando..."))]),"specialty_id-data":l(({row:t})=>[t.specialty_id?(n(),z(g,{key:0,color:"gray",variant:"solid"},{default:l(()=>[h(m(q.value.find(C=>C.id===t.specialty_id)?.name||"No definido"),1)]),_:2},1024)):(n(),d("span",_e,"-"))]),"actions-data":l(({row:t})=>[o(r,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:C=>P(t)},null,8,["onClick"])]),"commission_type-data":l(({row:t})=>[i("span",pe,m(t.commission_type==="both"?"Arriendo + Comisión":t.commission_type==="fixed_rent"?"Arriendo Mensual":"Solo Comisión"),1)]),"fixed_rent_cost-data":l(({row:t})=>[t.commission_type==="fixed_rent"||t.commission_type==="both"?(n(),d("span",fe,m(G(t.fixed_rent_cost)),1)):(n(),d("span",xe,"-"))]),"commission_rate-data":l(({row:t})=>[i("span",ye,m(t.commission_rate)+"%",1)]),"product_commission_rate-data":l(({row:t})=>[i("span",ve,m(t.product_commission_rate||0)+"%",1)]),_:1},8,["rows"])]),_:1}),o(I,{modelValue:v.value,"onUpdate:modelValue":a[13]||(a[13]=t=>v.value=t)},{default:l(()=>[o(M,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:l(()=>[i("div",be,[i("h3",he,m(f.value?"Editar Usuario y Rol":"Nuevo Usuario"),1),o(r,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:a[0]||(a[0]=t=>v.value=!1)})])]),default:l(()=>[i("form",{onSubmit:se(D,["prevent"]),class:"space-y-4 py-2"},[f.value?(n(),d("div",ge,[a[17]||(a[17]=h(" Editando a: ",-1)),i("span",ke,m(f.value.full_name||"Usuario"),1)])):(n(),d("div",Ve,[o(_,{label:"Nombre Completo",name:"fullname",required:""},{default:l(()=>[o(b,{modelValue:e.full_name,"onUpdate:modelValue":a[1]||(a[1]=t=>e.full_name=t),icon:"i-heroicons-user"},null,8,["modelValue"])]),_:1}),o(_,{label:"Correo Electrónico",name:"email",required:""},{default:l(()=>[o(b,{modelValue:e.email,"onUpdate:modelValue":a[2]||(a[2]=t=>e.email=t),type:"email",icon:"i-heroicons-envelope"},null,8,["modelValue"])]),_:1}),o(_,{label:"Contraseña",name:"password",required:""},{default:l(()=>[o(b,{modelValue:e.password,"onUpdate:modelValue":a[3]||(a[3]=t=>e.password=t),type:"password",icon:"i-heroicons-lock-closed"},null,8,["modelValue"])]),_:1})])),o(_,{label:"Rol",name:"role"},{default:l(()=>[o(A,{modelValue:e.role,"onUpdate:modelValue":a[4]||(a[4]=t=>e.role=t),options:[{label:"Administrador",value:"admin"},{label:"Usuario",value:"stylist"}]},null,8,["modelValue"])]),_:1}),o(_,{label:"Sucursal Asignada",name:"branch"},{default:l(()=>[o(A,{modelValue:e.branch_id,"onUpdate:modelValue":a[5]||(a[5]=t=>e.branch_id=t),options:w.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una sucursal"},null,8,["modelValue","options"])]),_:1}),e.role==="stylist"?(n(),z(_,{key:2,label:"Especialidad",name:"specialty"},{default:l(()=>[o(A,{modelValue:e.specialty_id,"onUpdate:modelValue":a[6]||(a[6]=t=>e.specialty_id=t),options:q.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una especialidad",clearable:""},null,8,["modelValue","options"])]),_:1})):k("",!0),e.role==="stylist"||e.role==="admin"?(n(),d("div",we,[a[18]||(a[18]=i("p",{class:"text-sm font-semibold text-slate-700 dark:text-slate-200"},"Esquema de Ganancias",-1)),i("div",Ue,[o(T,{modelValue:e.has_fixed_rent,"onUpdate:modelValue":a[7]||(a[7]=t=>e.has_fixed_rent=t),label:"Arriendo puesto mensual"},null,8,["modelValue"]),e.has_fixed_rent?(n(),d("div",Ce,[o(_,{label:"Valor arriendo mensual",name:"fixed_rent_cost"},{default:l(()=>[o(b,{modelValue:e.fixed_rent_cost,"onUpdate:modelValue":a[8]||(a[8]=t=>e.fixed_rent_cost=t),type:"number",icon:"i-heroicons-currency-dollar",placeholder:"200000",size:"sm"},null,8,["modelValue"])]),_:1})])):k("",!0)]),i("div",qe,[o(T,{modelValue:e.has_commission,"onUpdate:modelValue":a[9]||(a[9]=t=>e.has_commission=t),label:"Comisión (%)"},null,8,["modelValue"]),e.has_commission?(n(),d("div",Ne,[o(_,{label:"% Comisión Servicios",name:"commission_rate",help:"Porcentaje que GANA la peluquería por servicio"},{default:l(()=>[o(b,{modelValue:e.commission_rate,"onUpdate:modelValue":a[10]||(a[10]=t=>e.commission_rate=t),type:"number",icon:"i-heroicons-scissors",placeholder:"0",size:"sm"},null,8,["modelValue"])]),_:1}),o(_,{label:"% Comisión Productos",name:"product_commission_rate",help:"Porcentaje que GANA la peluquería por venta de productos"},{default:l(()=>[o(b,{modelValue:e.product_commission_rate,"onUpdate:modelValue":a[11]||(a[11]=t=>e.product_commission_rate=t),type:"number",icon:"i-heroicons-shopping-bag",placeholder:"0",size:"sm"},null,8,["modelValue"])]),_:1})])):k("",!0)])])):k("",!0),i("div",Se,[o(r,{color:"gray",variant:"ghost",label:"Cancelar",onClick:a[12]||(a[12]=t=>v.value=!1)}),o(r,{type:"submit",color:"emerald",label:f.value?"Guardar Cambios":"Crear Usuario",loading:N.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"])])}}});export{Oe as default};
