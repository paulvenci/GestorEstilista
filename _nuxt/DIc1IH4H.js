import{f as j}from"./Jb28Xoru.js";import{_ as R}from"./BIYzKrfT.js";import{_ as I,a as F}from"./ixa2wK3h.js";import{_ as L}from"./DObld12K.js";import{_ as O,b as W}from"./BH9kdvlr.js";import{_ as H}from"./Cl6eWB1s.js";import{_ as J}from"./Cz_GaU6p.js";import{k as K,U as Q,a0 as X,a3 as Y,f as Z,l as ee,c as r,a as i,b as o,w as l,r as y,o as n,t as c,D as M,d as q,W as te,G as g,z as ae}from"./CGccSeMY.js";import"./BYYinPt_.js";import"./DlAUqK2U.js";import"./CYxRQd5v.js";import"./Lrvz9fIF.js";import"./90Ut9LIE.js";const oe={class:"space-y-6"},se={class:"flex justify-between items-center"},le={key:0},ie={key:1,class:"text-xs text-slate-400"},ne={key:1,class:"text-xs text-slate-400"},re={class:"text-xs font-medium px-2 py-1 rounded bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300"},de={key:0,class:"font-medium text-slate-700 dark:text-slate-200"},me={key:1,class:"text-slate-400"},ce={class:"font-medium text-slate-700 dark:text-slate-200"},ue={class:"font-medium text-slate-700 dark:text-slate-200"},_e={class:"flex items-center justify-between"},pe={class:"text-base font-semibold text-gray-900 dark:text-white"},fe={key:0,class:"text-sm text-slate-500 mb-2"},ye={class:"font-bold text-slate-900 dark:text-white"},be={key:1,class:"space-y-4"},xe={key:3,class:"bg-slate-50 dark:bg-slate-800/50 p-4 rounded-lg border border-slate-200 dark:border-slate-700 space-y-4"},ve={class:"space-y-2"},he={key:0,class:"pl-6"},ke={class:"space-y-3"},ge={key:0,class:"grid grid-cols-2 gap-4 pl-6"},Ve={class:"flex justify-end gap-3 mt-6"},Be=K({__name:"index",setup(Ue){const b=Q(),T=X("headerTitle",()=>"Equipo");T.value="Gestión Rol";const N=Y(),S=y([]),v=y([]),V=y([]),f=y(!1),U=y(!1),u=y(null),_=y(null),e=ae({full_name:"",email:"",password:"",role:"stylist",branch_id:"",specialty_id:"",commission_rate:0,product_commission_rate:0,has_fixed_rent:!1,has_commission:!1,fixed_rent_cost:0}),G=[{key:"full_name",label:"Nombre"},{key:"role",label:"Rol"},{key:"specialty_id",label:"Especialidad"},{key:"commission_type",label:"Tipo"},{key:"fixed_rent_cost",label:"Arriendo"},{key:"commission_rate",label:"% Serv"},{key:"product_commission_rate",label:"% Prod"},{key:"branch_id",label:"Sucursal"},{key:"actions",label:""}],z=s=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(s),w=async()=>{let s=N.value?.id;if(!s){const{data:{session:t}}=await b.auth.getSession();t?.user&&(s=t.user.id)}if(s){if(!_.value){const{data:t}=await b.from("profiles").select("tenant_id").eq("id",s).single();t&&(_.value=t.tenant_id)}if(_.value){const{data:t,error:d}=await b.from("profiles").select("*").eq("tenant_id",_.value);d&&console.error("Error fetching team:",d),t&&(S.value=t);const{data:p}=await b.from("branches").select("id, name").eq("tenant_id",_.value).eq("active",!0);p&&(v.value=p);const{data:h}=await b.from("specialties").select("id, name").eq("tenant_id",_.value);h&&(V.value=h)}}};Z(N,()=>{w()},{immediate:!0});const D=()=>{u.value=null,e.full_name="",e.email="",e.password="",e.role="stylist",e.branch_id="",e.specialty_id="",e.commission_rate=0,e.product_commission_rate=0,e.has_fixed_rent=!1,e.has_commission=!1,e.fixed_rent_cost=0,f.value=!0},P=s=>{u.value=s,e.full_name=s.full_name,e.role=s.role,e.branch_id=s.branch_id||"",e.specialty_id=s.specialty_id||"",e.commission_rate=s.commission_rate||0,e.product_commission_rate=s.product_commission_rate||0,e.has_fixed_rent=s.commission_type==="fixed_rent"||s.commission_type==="both",e.has_commission=s.commission_type==="percentage"||s.commission_type==="both",e.fixed_rent_cost=s.fixed_rent_cost||0,f.value=!0},B=async()=>{if(!_.value){alert("Error: No se ha identificado tu negocio.");return}U.value=!0;try{const s=e.has_fixed_rent&&e.has_commission?"both":e.has_fixed_rent?"fixed_rent":(e.has_commission,"percentage"),t={role:e.role,branch_id:e.branch_id||null,specialty_id:e.specialty_id||null,commission_type:s,commission_rate:e.has_commission?Number(e.commission_rate):0,product_commission_rate:e.has_commission?Number(e.product_commission_rate):0,fixed_rent_cost:e.has_fixed_rent?Number(e.fixed_rent_cost):0};if(u.value){const{data:d,error:p}=await b.from("profiles").update(t).eq("id",u.value.id).select();if(p)throw p;alert("Miembro actualizado correctamente.")}else{const d=await $fetch("/api/admin/users",{method:"POST",body:{email:e.email,password:e.password,full_name:e.full_name,tenant_id:_.value,...t}});alert("Usuario creado correctamente")}f.value=!1,await w()}catch(s){alert("Error: "+(s.statusMessage||s.message))}finally{U.value=!1}};return ee(()=>{w()}),(s,t)=>{const d=j,p=R,h=I,A=L,x=W,m=O,C=H,E=F,$=J;return n(),r("div",oe,[i("div",se,[t[14]||(t[14]=i("div",{class:"hidden md:block"},[i("h1",{class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},"Gestión Rol"),i("p",{class:"text-slate-500 dark:text-slate-400 mt-1"},"Configura roles, permisos y esquemas de comisiones.")],-1)),o(d,{label:"Nuevo Usuario",icon:"i-heroicons-user-plus",color:"emerald",size:"lg",onClick:D,class:"shadow-lg shadow-emerald-500/20"})]),o(A,{ui:{body:{padding:"p-0"}}},{default:l(()=>[o(h,{rows:S.value,columns:G,ui:{thead:"bg-slate-50 dark:bg-slate-800/50",th:{color:"text-slate-900 dark:text-white"},td:{color:"text-slate-600 dark:text-slate-400"}}},{"role-data":l(({row:a})=>[o(p,{color:a.role==="admin"?"purple":"blue",variant:"subtle"},{default:l(()=>[q(c(a.role==="admin"?"Administrador":"Usuario"),1)]),_:2},1032,["color"])]),"branch_id-data":l(({row:a})=>[v.value.length>0?(n(),r("span",le,c(v.value.find(k=>k.id===a.branch_id)?.name||"Sin Asignar"),1)):(n(),r("span",ie,"Cargando..."))]),"specialty_id-data":l(({row:a})=>[a.specialty_id?(n(),M(p,{key:0,color:"gray",variant:"solid"},{default:l(()=>[q(c(V.value.find(k=>k.id===a.specialty_id)?.name||"No definido"),1)]),_:2},1024)):(n(),r("span",ne,"-"))]),"actions-data":l(({row:a})=>[o(d,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:k=>P(a)},null,8,["onClick"])]),"commission_type-data":l(({row:a})=>[i("span",re,c(a.commission_type==="both"?"Arriendo + Comisión":a.commission_type==="fixed_rent"?"Arriendo Mensual":"Solo Comisión"),1)]),"fixed_rent_cost-data":l(({row:a})=>[a.commission_type==="fixed_rent"?(n(),r("span",de,c(z(a.fixed_rent_cost)),1)):(n(),r("span",me,"-"))]),"commission_rate-data":l(({row:a})=>[i("span",ce,c(a.commission_rate)+"%",1)]),"product_commission_rate-data":l(({row:a})=>[i("span",ue,c(a.product_commission_rate||0)+"%",1)]),_:1},8,["rows"])]),_:1}),o($,{modelValue:f.value,"onUpdate:modelValue":t[13]||(t[13]=a=>f.value=a)},{default:l(()=>[o(A,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:l(()=>[i("div",_e,[i("h3",pe,c(u.value?"Editar Usuario y Rol":"Nuevo Usuario"),1),o(d,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:t[0]||(t[0]=a=>f.value=!1)})])]),default:l(()=>[i("form",{onSubmit:te(B,["prevent"]),class:"space-y-4 py-2"},[u.value?(n(),r("div",fe,[t[15]||(t[15]=q(" Editando a: ",-1)),i("span",ye,c(u.value.full_name||"Usuario"),1)])):(n(),r("div",be,[o(m,{label:"Nombre Completo",name:"fullname",required:""},{default:l(()=>[o(x,{modelValue:e.full_name,"onUpdate:modelValue":t[1]||(t[1]=a=>e.full_name=a),icon:"i-heroicons-user"},null,8,["modelValue"])]),_:1}),o(m,{label:"Correo Electrónico",name:"email",required:""},{default:l(()=>[o(x,{modelValue:e.email,"onUpdate:modelValue":t[2]||(t[2]=a=>e.email=a),type:"email",icon:"i-heroicons-envelope"},null,8,["modelValue"])]),_:1}),o(m,{label:"Contraseña",name:"password",required:""},{default:l(()=>[o(x,{modelValue:e.password,"onUpdate:modelValue":t[3]||(t[3]=a=>e.password=a),type:"password",icon:"i-heroicons-lock-closed"},null,8,["modelValue"])]),_:1})])),o(m,{label:"Rol",name:"role"},{default:l(()=>[o(C,{modelValue:e.role,"onUpdate:modelValue":t[4]||(t[4]=a=>e.role=a),options:[{label:"Administrador",value:"admin"},{label:"Usuario",value:"stylist"}]},null,8,["modelValue"])]),_:1}),o(m,{label:"Sucursal Asignada",name:"branch"},{default:l(()=>[o(C,{modelValue:e.branch_id,"onUpdate:modelValue":t[5]||(t[5]=a=>e.branch_id=a),options:v.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una sucursal"},null,8,["modelValue","options"])]),_:1}),e.role==="stylist"?(n(),M(m,{key:2,label:"Especialidad",name:"specialty"},{default:l(()=>[o(C,{modelValue:e.specialty_id,"onUpdate:modelValue":t[6]||(t[6]=a=>e.specialty_id=a),options:V.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una especialidad",clearable:""},null,8,["modelValue","options"])]),_:1})):g("",!0),e.role==="stylist"||e.role==="admin"?(n(),r("div",xe,[t[16]||(t[16]=i("p",{class:"text-sm font-semibold text-slate-700 dark:text-slate-200"},"Esquema de Ganancias",-1)),i("div",ve,[o(E,{modelValue:e.has_fixed_rent,"onUpdate:modelValue":t[7]||(t[7]=a=>e.has_fixed_rent=a),label:"Arriendo puesto mensual"},null,8,["modelValue"]),e.has_fixed_rent?(n(),r("div",he,[o(m,{label:"Valor arriendo mensual",name:"fixed_rent_cost"},{default:l(()=>[o(x,{modelValue:e.fixed_rent_cost,"onUpdate:modelValue":t[8]||(t[8]=a=>e.fixed_rent_cost=a),type:"number",icon:"i-heroicons-currency-dollar",placeholder:"200000",size:"sm"},null,8,["modelValue"])]),_:1})])):g("",!0)]),i("div",ke,[o(E,{modelValue:e.has_commission,"onUpdate:modelValue":t[9]||(t[9]=a=>e.has_commission=a),label:"Comisión (%)"},null,8,["modelValue"]),e.has_commission?(n(),r("div",ge,[o(m,{label:"% Comisión Servicios",name:"commission_rate",help:"Porcentaje que GANA la peluquería por servicio"},{default:l(()=>[o(x,{modelValue:e.commission_rate,"onUpdate:modelValue":t[10]||(t[10]=a=>e.commission_rate=a),type:"number",icon:"i-heroicons-scissors",placeholder:"0",size:"sm"},null,8,["modelValue"])]),_:1}),o(m,{label:"% Comisión Productos",name:"product_commission_rate",help:"Porcentaje que GANA la peluquería por venta de productos"},{default:l(()=>[o(x,{modelValue:e.product_commission_rate,"onUpdate:modelValue":t[11]||(t[11]=a=>e.product_commission_rate=a),type:"number",icon:"i-heroicons-shopping-bag",placeholder:"0",size:"sm"},null,8,["modelValue"])]),_:1})])):g("",!0)])])):g("",!0),i("div",Ve,[o(d,{color:"gray",variant:"ghost",label:"Cancelar",onClick:t[12]||(t[12]=a=>f.value=!1)}),o(d,{type:"submit",color:"emerald",label:u.value?"Guardar Cambios":"Crear Usuario",loading:U.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"])])}}});export{Be as default};
