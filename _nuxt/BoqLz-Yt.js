import{_ as F,b as $}from"./CbHYdG4T.js";import{_ as O}from"./BzJQAV8m.js";import{a as J,_ as K}from"./D_-VMN5q.js";import{_ as Q,u}from"./DyShVoUM.js";import{_ as X}from"./CMGe3p3I.js";import{_ as Y}from"./CLVal4fm.js";import{e as Z,f as ee,G as ae,c as v,a as r,h as a,m as te,w as s,k as S,b as t,r as _,o as k,j as T,t as A,d as h,F as M,s as oe,y as B,A as D,l as ne}from"./DCtqWaPg.js";import"./B9IdNyOX.js";import"./DlAUqK2U.js";import"./P2xMnsBy.js";import"./CVz2p-XC.js";import"./0kWZEwC_.js";import"./Bj2lqA5q.js";import"./DP9lOQ8D.js";const re={class:"p-4 max-w-4xl mx-auto items-start gap-6"},le={class:"font-semibold text-lg flex items-center gap-2"},se={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},ie={class:"bg-gray-50 dark:bg-slate-800 p-4 rounded-lg text-sm"},de={class:"p-3 bg-white dark:bg-slate-900 border rounded border-gray-200 dark:border-slate-700 italic text-gray-600 dark:text-gray-400"},ce={class:"flex justify-between items-center bg-gray-50 dark:bg-slate-800/50 p-4 rounded-xl border border-gray-100 dark:border-slate-700/50"},me={class:"flex items-center gap-2"},ue={class:"font-semibold text-lg flex items-center gap-2"},pe={key:0,class:"bg-emerald-50 dark:bg-emerald-900/20 p-4 rounded-lg border border-emerald-200 dark:border-emerald-800"},_e={class:"flex items-center gap-2"},ge={class:"text-sm bg-white dark:bg-slate-800 px-3 py-1.5 rounded border border-emerald-200 dark:border-slate-600 flex-1 truncate text-emerald-600 dark:text-emerald-400"},fe={class:"grid grid-cols-1 md:grid-cols-2 gap-6"},be={class:"grid grid-cols-1 md:grid-cols-3 gap-6"},ke={class:"grid grid-cols-2 sm:grid-cols-4 md:grid-cols-7 gap-3"},he={class:"flex justify-end"},Me=Z({__name:"configuracion",setup(ye){const m=ee(),j=_(""),E=D(()=>["admin","superadmin"].includes(j.value)),V=_(!1),U=_(!1),i=_({whatsapp_template:"",enable_reminders:!1,reminder_hours_before:24,whatsapp_phone_number_id:"",whatsapp_access_token:""}),C=_(!1),y=_(""),l=_({booking_enabled:!0,work_start_time:"09:00",work_end_time:"19:00",slot_interval_min:30,work_monday:!0,work_tuesday:!0,work_wednesday:!0,work_thursday:!0,work_friday:!0,work_saturday:!0,work_sunday:!1,confirmation_required:!0,confirmation_message:"Su cita ha sido agendada y está pendiente de confirmación."}),G=[{key:"work_monday",label:"Lun"},{key:"work_tuesday",label:"Mar"},{key:"work_wednesday",label:"Mié"},{key:"work_thursday",label:"Jue"},{key:"work_friday",label:"Vie"},{key:"work_saturday",label:"Sáb"},{key:"work_sunday",label:"Dom"}],q=D(()=>{if(!y.value)return"";const e=ne().app.baseURL||"/",d=e.endsWith("/")?e:e+"/";return`${window.location.origin}${d}${y.value}`}),H=()=>{navigator.clipboard.writeText(q.value),u().add({title:"Link copiado al portapapeles",icon:"i-heroicons-clipboard-document-check",color:"green"})},w={cliente:"Juan Pérez",fecha:new Date().toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"}),hora:"14:30",estilista:"Ana Gómez"},I=D(()=>{let o=i.value.whatsapp_template||"Hola {cliente}, recordamos tu cita en GestorEstilista el {fecha} a las {hora}.";return o=o.replace(/{cliente}/g,w.cliente),o=o.replace(/{fecha}/g,w.fecha),o=o.replace(/{hora}/g,w.hora),o=o.replace(/{estilista}/g,w.estilista),o}),z=async()=>{try{const{data:{user:o}}=await m.auth.getUser();if(!o)return;const{data:e}=await m.from("profiles").select("role").eq("id",o.id).single();e&&(j.value=e.role||"");const{data:d,error:g}=await m.from("tenants").select("id, slug, settings").single();if(g){console.error("Error fetching settings:",g);return}if(d&&d.settings&&(i.value={...i.value,...d.settings}),y.value=d?.slug||"",d?.id){const{data:c}=await m.from("booking_settings").select("*").eq("tenant_id",d.id).single();c&&(l.value={...l.value,...c})}}catch(o){console.error(o)}},N=async()=>{V.value=!0;try{const{error:o}=await m.rpc("update_tenant_settings",{p_settings:i.value});if(o)throw o;u().add({title:"Configuración guardada",icon:"i-heroicons-check-circle",color:"green"})}catch(o){u().add({title:"Error al guardar",description:o.message,icon:"i-heroicons-x-circle",color:"red"})}finally{V.value=!1}},P=async()=>{if(!i.value.whatsapp_phone_number_id||!i.value.whatsapp_access_token)return u().add({title:"Faltan credenciales",color:"red"});const o=prompt("Ingresa un número de celular para la prueba (con código de país, ej: 56912345678):");if(o){U.value=!0;try{const{data:e,error:d}=await m.functions.invoke("send-reminders",{body:{action:"test",to:o,test_settings:i.value}});if(d)throw d;u().add({title:"Mensaje enviado",description:"Revisa tu WhatsApp",color:"green"})}catch(e){u().add({title:"Error en la prueba",description:e.message,color:"red"})}finally{U.value=!1}}};ae(()=>{z()});const R=async()=>{C.value=!0;try{const{data:o}=await m.from("tenants").select("id").single();if(!o)throw new Error("Tenant no encontrado");const{id:e,created_at:d,updated_at:g,tenant_id:c,...f}=l.value,{error:p}=await m.from("booking_settings").upsert({...f,tenant_id:o.id,updated_at:new Date().toISOString()},{onConflict:"tenant_id"});if(p)throw p;u().add({title:"Configuración de agendamiento guardada",icon:"i-heroicons-check-circle",color:"green"})}catch(o){u().add({title:"Error al guardar",description:o.message,icon:"i-heroicons-x-circle",color:"red"})}finally{C.value=!1}};return(o,e)=>{const d=$,g=O,c=J,f=Q,p=X,b=K,x=F,L=Y;return k(),v("div",re,[e[19]||(e[19]=r("div",{class:"mb-6"},[r("h1",{class:"text-2xl font-bold text-gray-900 dark:text-white"},"Configuración"),r("p",{class:"text-gray-500 dark:text-gray-400"},"Administra las preferencias de tu negocio.")],-1)),a(E)?(k(),te(L,{key:0},{header:s(()=>[r("h2",le,[t(d,{name:"i-heroicons-chat-bubble-left-right",class:"text-green-500"}),e[11]||(e[11]=h(" Notificaciones WhatsApp ",-1))])]),default:s(()=>[r("form",{onSubmit:T(N,["prevent"]),class:"space-y-6"},[t(c,{label:"Plantilla de Mensaje (Citas)",help:"Variables: {cliente}, {fecha}, {hora}, {estilista}"},{default:s(()=>[t(g,{modelValue:a(i).whatsapp_template,"onUpdate:modelValue":e[0]||(e[0]=n=>a(i).whatsapp_template=n),rows:4,placeholder:"Hola {cliente}, te recordamos tu cita el {fecha} a las {hora} con {estilista}."},null,8,["modelValue"])]),_:1}),t(f),r("div",se,[t(c,{label:"Habilitar Recordatorios Automáticos",help:"Enviar mensajes automáticamente a los clientes"},{default:s(()=>[t(p,{modelValue:a(i).enable_reminders,"onUpdate:modelValue":e[1]||(e[1]=n=>a(i).enable_reminders=n)},null,8,["modelValue"])]),_:1}),t(c,{label:"Anticipación (Horas)",help:"Cuántas horas antes de la cita enviar el mensaje"},{default:s(()=>[t(b,{modelValue:a(i).reminder_hours_before,"onUpdate:modelValue":e[2]||(e[2]=n=>a(i).reminder_hours_before=n),type:"number",min:"1",max:"72",placeholder:"24",icon:"i-heroicons-clock"},null,8,["modelValue"])]),_:1}),t(c,{label:"WhatsApp Phone Number ID",help:"ID del número de teléfono en Meta for Developers"},{default:s(()=>[t(b,{modelValue:a(i).whatsapp_phone_number_id,"onUpdate:modelValue":e[3]||(e[3]=n=>a(i).whatsapp_phone_number_id=n),icon:"i-heroicons-hashtag",placeholder:"Ej: 100609346..."},null,8,["modelValue"])]),_:1}),t(c,{label:"WhatsApp Access Token",help:"Token de acceso (Permanente o de Sistema)"},{default:s(()=>[t(b,{modelValue:a(i).whatsapp_access_token,"onUpdate:modelValue":e[4]||(e[4]=n=>a(i).whatsapp_access_token=n),type:"password",icon:"i-heroicons-key",placeholder:"Ej: EAAG..."},null,8,["modelValue"])]),_:1})]),t(f),r("div",ie,[e[12]||(e[12]=r("p",{class:"font-medium mb-2 text-gray-700 dark:text-gray-300"},"Vista Previa:",-1)),r("div",de,A(a(I)),1)]),r("div",ce,[r("div",me,[t(x,{onClick:P,loading:a(U),color:"green",variant:"soft",icon:"i-heroicons-paper-airplane"},{default:s(()=>[...e[13]||(e[13]=[h(" Probar Configuración ",-1)])]),_:1},8,["loading"]),e[14]||(e[14]=r("p",{class:"text-[10px] text-gray-500 max-w-[200px]"},"Se enviará un mensaje de prueba al número que indiques.",-1))]),t(x,{type:"submit",loading:a(V),color:"primary",class:"px-8",icon:"i-heroicons-check"},{default:s(()=>[...e[15]||(e[15]=[h(" Guardar Cambios ",-1)])]),_:1},8,["loading"])])],32)]),_:1})):S("",!0),t(L,{class:"mt-6"},{header:s(()=>[r("h2",ue,[t(d,{name:"i-heroicons-calendar-days",class:"text-emerald-500"}),e[16]||(e[16]=h(" Agendamiento Online ",-1))])]),default:s(()=>[r("form",{onSubmit:T(R,["prevent"]),class:"space-y-6"},[a(y)?(k(),v("div",pe,[e[17]||(e[17]=r("p",{class:"text-sm font-medium text-emerald-700 dark:text-emerald-300 mb-1"},"Link público de agendamiento:",-1)),r("div",_e,[r("code",ge,A(a(q)),1),t(x,{icon:"i-heroicons-clipboard",color:"emerald",variant:"soft",size:"xs",onClick:H})])])):S("",!0),a(E)?(k(),v(M,{key:1},[r("div",fe,[t(c,{label:"Activar Agendamiento Online",help:"Los clientes podrán agendar citas desde el link público"},{default:s(()=>[t(p,{modelValue:a(l).booking_enabled,"onUpdate:modelValue":e[5]||(e[5]=n=>a(l).booking_enabled=n)},null,8,["modelValue"])]),_:1}),t(c,{label:"Requerir Confirmación",help:"Las citas quedarán como 'pendientes' hasta que las confirmes"},{default:s(()=>[t(p,{modelValue:a(l).confirmation_required,"onUpdate:modelValue":e[6]||(e[6]=n=>a(l).confirmation_required=n)},null,8,["modelValue"])]),_:1})]),t(f,{label:"Horario de Trabajo"}),r("div",be,[t(c,{label:"Hora de Apertura"},{default:s(()=>[t(b,{modelValue:a(l).work_start_time,"onUpdate:modelValue":e[7]||(e[7]=n=>a(l).work_start_time=n),type:"time",icon:"i-heroicons-clock"},null,8,["modelValue"])]),_:1}),t(c,{label:"Hora de Cierre"},{default:s(()=>[t(b,{modelValue:a(l).work_end_time,"onUpdate:modelValue":e[8]||(e[8]=n=>a(l).work_end_time=n),type:"time",icon:"i-heroicons-clock"},null,8,["modelValue"])]),_:1}),t(c,{label:"Intervalo (min)",help:"Duración de cada slot de tiempo"},{default:s(()=>[t(b,{modelValue:a(l).slot_interval_min,"onUpdate:modelValue":e[9]||(e[9]=n=>a(l).slot_interval_min=n),type:"number",min:"15",max:"120",step:"15",icon:"i-heroicons-arrows-right-left"},null,8,["modelValue"])]),_:1})]),t(f,{label:"Días Laborales"}),r("div",ke,[(k(),v(M,null,oe(G,n=>r("div",{key:n.key,class:B(["flex flex-col items-center gap-2 p-3 rounded-lg border",a(l)[n.key]?"border-emerald-500 bg-emerald-50 dark:bg-emerald-900/20":"border-gray-200 dark:border-slate-700"])},[r("span",{class:B(["text-xs font-medium",a(l)[n.key]?"text-emerald-600 dark:text-emerald-400":"text-gray-400"])},A(n.label),3),t(p,{modelValue:a(l)[n.key],"onUpdate:modelValue":W=>a(l)[n.key]=W},null,8,["modelValue","onUpdate:modelValue"])],2)),64))]),t(c,{label:"Mensaje de Confirmación",help:"Se mostrará al cliente al finalizar la reserva"},{default:s(()=>[t(g,{modelValue:a(l).confirmation_message,"onUpdate:modelValue":e[10]||(e[10]=n=>a(l).confirmation_message=n),rows:2,placeholder:"Su cita ha sido agendada y está pendiente de confirmación."},null,8,["modelValue"])]),_:1}),r("div",he,[t(x,{type:"submit",loading:a(C),color:"emerald",icon:"i-heroicons-check"},{default:s(()=>[...e[18]||(e[18]=[h(" Guardar Configuración de Agendamiento ",-1)])]),_:1},8,["loading"])])],64)):S("",!0)],32)]),_:1})])}}});export{Me as default};
