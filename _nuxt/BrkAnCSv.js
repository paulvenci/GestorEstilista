import{f as Y}from"./Jb28Xoru.js";import{_ as Z}from"./BIYzKrfT.js";import{_ as ee}from"./DObld12K.js";import{_ as ae}from"./ixa2wK3h.js";import{_ as le,b as te}from"./BH9kdvlr.js";import{_ as se}from"./Cl6eWB1s.js";import{_ as oe}from"./Cz_GaU6p.js";import{k as ne,a6 as ie,U as re,a0 as de,l as ue,c as f,a as o,b as a,t as m,G as C,w as s,r as c,o as p,d as S,D as me,W as j,z,a4 as ce}from"./CGccSeMY.js";import"./BYYinPt_.js";import"./DlAUqK2U.js";import"./CYxRQd5v.js";import"./Lrvz9fIF.js";import"./90Ut9LIE.js";const ve={class:"space-y-6"},pe={class:"flex items-center justify-between"},fe={class:"flex items-center gap-4"},_e={class:"hidden md:block"},be={key:0,class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},ge={key:1,class:"flex items-center gap-2 mt-1"},xe={class:"text-slate-500 text-sm"},ye={class:"flex gap-3"},he={key:0,class:"grid grid-cols-1 md:grid-cols-3 gap-6"},ke={class:"flex flex-col"},we={class:"text-2xl font-bold text-emerald-600"},Ve={class:"flex flex-col"},Ue={class:"text-2xl font-bold text-slate-900 dark:text-white"},Ce={class:"flex flex-col"},Se={class:"text-2xl font-bold text-blue-600"},Ne={class:"space-y-4"},Ee={class:"flex justify-between items-center"},Te={key:1,class:"space-y-4"},De={class:"flex justify-between items-center"},qe={key:0},Be={key:1,class:"text-xs text-slate-400"},$e={class:"flex items-center justify-between"},Me={key:0,class:"text-xs text-red-500 mt-1"},je={class:"flex justify-end gap-3 mt-6"},ze={class:"flex items-center justify-between"},Ae={class:"text-base font-semibold text-gray-900 dark:text-white"},Pe={key:0,class:"text-sm text-slate-500 mb-2"},Oe={class:"font-bold text-slate-900 dark:text-white"},Ge={key:1,class:"space-y-4"},Re={class:"flex justify-end gap-3 mt-6"},Fe={class:"flex items-center justify-between"},Ie={class:"flex justify-end gap-3 mt-4"},oa=ne({__name:"[slug]",setup(Le){const O=ie(),_=re(),G=de("headerTitle",()=>"Detalle");G.value="Detalle";const n=c(null),w=c([]),V=c(!1),T=c(!1),r=z({name:"",slug:"",status:"active",plan_id:null}),x=c(!1),D=c(!1),b=c(null),q=c([]),i=z({full_name:"",email:"",password:"",role:"stylist",branch_id:""}),R=()=>{console.log("Opening Create User Modal"),b.value=null,i.full_name="",i.email="",i.password="",i.role="stylist",i.branch_id="",x.value=!0},F=t=>{console.log("Editing user:",t),b.value=t,i.full_name=t.full_name,i.role=t.role,i.branch_id=t.branch_id,x.value=!0},I=[{key:"full_name",label:"Nombre"},{key:"role",label:"Rol"},{key:"branch_id",label:"Sucursal"},{key:"actions",label:""}],A=c([]),L=async()=>{const{data:t}=await _.from("plans").select("id, name");t&&(A.value=t)},N=async()=>{const t=O.params.slug,{data:e}=await _.from("tenants").select("*, plans(*)").eq("slug",t).single();if(e){n.value=e;const{data:d}=await _.from("branches").select("*").eq("tenant_id",e.id).order("is_main",{ascending:!1});d&&(w.value=d);const{data:h}=await _.from("profiles").select("*").eq("tenant_id",e.id);h&&(q.value=h)}},W=async()=>{if(n.value){T.value=!0;try{const{error:t}=await _.from("tenants").update({name:r.name,slug:r.slug,status:r.status,plan_id:r.plan_id}).eq("id",n.value.id);if(t)throw t;if(r.slug!==n.value.slug)return alert("Slug actualizado. Redirigiendo..."),ce(`/admin/tenants/${r.slug}`);V.value=!1,await N(),alert("Negocio actualizado correctamente")}catch(t){alert("Error: "+t.message)}finally{T.value=!1}}},H=()=>{n.value&&(r.name=n.value.name,r.slug=n.value.slug,r.status=n.value.status,r.plan_id=n.value.plan_id,V.value=!0)};ue(()=>{N(),L()});const y=c(!1),B=c(!1),u=z({name:"",address:""}),U=c(null),J=t=>{U.value=t.id,u.name=t.name,u.address=t.address,y.value=!0},K=[{key:"name",label:"Nombre"},{key:"address",label:"Dirección"},{key:"is_main",label:"Tipo"},{key:"active",label:"Estado"},{key:"actions",label:""}],Q=async()=>{D.value=!0;try{if(b.value){const{error:t}=await _.from("profiles").update({role:i.role,branch_id:i.branch_id}).eq("id",b.value.id);if(t)throw t;alert("Usuario actualizado correctamente")}else{if(!n.value)throw new Error("Tenant context missing");const t=await $fetch("/api/admin/users",{method:"POST",body:{email:i.email,password:i.password,full_name:i.full_name,role:i.role,branch_id:i.branch_id||null,tenant_id:n.value.id}});alert("Usuario creado correctamente")}x.value=!1,await N()}catch(t){alert("Error: "+(t.statusMessage||t.message))}finally{D.value=!1}},X=async()=>{if(n.value){B.value=!0;try{if(U.value){const{error:t}=await _.from("branches").update({name:u.name,address:u.address}).eq("id",U.value);if(t)throw t}else{const{error:t}=await _.from("branches").insert({tenant_id:n.value.id,name:u.name,address:u.address,is_main:!1});if(t)throw t}y.value=!1,u.name="",u.address="",U.value=null,await N(),alert(U.value?"Sucursal actualizada":"Sucursal creada")}catch(t){alert("Error: "+t.message)}finally{B.value=!1}}};return(t,e)=>{const d=Y,h=Z,g=ee,P=ae,k=te,v=le,E=se,$=oe;return p(),f("div",ve,[o("div",pe,[o("div",fe,[a(d,{icon:"i-heroicons-arrow-left",color:"gray",variant:"ghost",to:"/admin/tenants"}),o("div",_e,[n.value?(p(),f("h1",be,m(n.value.name),1)):C("",!0),n.value?(p(),f("div",ge,[a(h,{color:n.value.status==="active"?"emerald":"red",variant:"subtle"},{default:s(()=>[S(m(n.value.status==="active"?"Activo":"Suspendido"),1)]),_:1},8,["color"]),o("span",xe,m(n.value.slug),1)])):C("",!0)])]),o("div",ye,[a(d,{label:"Editar Negocio",icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",onClick:H})])]),n.value?(p(),f("div",he,[a(g,null,{default:s(()=>[o("div",ke,[e[21]||(e[21]=o("span",{class:"text-sm text-slate-500 font-medium"},"Plan Actual",-1)),o("span",we,m(n.value.plans?.name||"Sin Plan"),1)])]),_:1}),a(g,null,{default:s(()=>[o("div",Ve,[e[22]||(e[22]=o("span",{class:"text-sm text-slate-500 font-medium"},"Próximo Pago",-1)),o("span",Ue,m(n.value.next_billing_date?new Date(n.value.next_billing_date).toLocaleDateString():"N/A"),1)])]),_:1}),a(g,null,{default:s(()=>[o("div",Ce,[e[23]||(e[23]=o("span",{class:"text-sm text-slate-500 font-medium"},"Sucursales",-1)),o("span",Se,m(w.value.length)+" / "+m(n.value.plans?.max_branches||1),1)])]),_:1})])):C("",!0),o("div",Ne,[o("div",Ee,[e[24]||(e[24]=o("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Sucursales",-1)),a(d,{label:"Nueva Sucursal",icon:"i-heroicons-plus",color:"emerald",size:"sm",onClick:e[0]||(e[0]=l=>y.value=!0)})]),a(g,{ui:{body:{padding:"p-0"}}},{default:s(()=>[a(P,{rows:w.value,columns:K},{"is_main-data":s(({row:l})=>[l.is_main?(p(),me(h,{key:0,color:"blue",variant:"subtle"},{default:s(()=>[...e[25]||(e[25]=[S("Casa Matriz",-1)])]),_:1})):C("",!0)]),"active-data":s(({row:l})=>[a(h,{color:l.active?"emerald":"gray",variant:"subtle"},{default:s(()=>[S(m(l.active?"Operativa":"Cerrada"),1)]),_:2},1032,["color"])]),"actions-data":s(({row:l})=>[a(d,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:M=>J(l)},null,8,["onClick"])]),_:1},8,["rows"])]),_:1})]),(q.value.length>0,p(),f("div",Te,[o("div",De,[e[26]||(e[26]=o("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Usuarios",-1)),a(d,{label:"Nuevo Usuario",icon:"i-heroicons-user-plus",color:"emerald",size:"sm",onClick:R})]),a(g,{ui:{body:{padding:"p-0"}}},{default:s(()=>[a(P,{rows:q.value,columns:I},{"role-data":s(({row:l})=>[a(h,{color:l.role==="admin"?"purple":"blue",variant:"subtle"},{default:s(()=>[S(m(l.role==="admin"?"Administrador":"Estilista"),1)]),_:2},1032,["color"])]),"branch_id-data":s(({row:l})=>[w.value.length>0?(p(),f("span",qe,m(w.value.find(M=>M.id===l.branch_id)?.name||"Sin Asignar"),1)):(p(),f("span",Be,"Cargando..."))]),"actions-data":s(({row:l})=>[a(d,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:M=>F(l)},null,8,["onClick"])]),_:1},8,["rows"])]),_:1})])),a($,{modelValue:V.value,"onUpdate:modelValue":e[7]||(e[7]=l=>V.value=l)},{default:s(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:s(()=>[o("div",$e,[e[27]||(e[27]=o("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Editar Negocio",-1)),a(d,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[1]||(e[1]=l=>V.value=!1)})])]),default:s(()=>[o("form",{onSubmit:j(W,["prevent"]),class:"space-y-4 py-2"},[a(v,{label:"Nombre del Negocio",name:"name"},{default:s(()=>[a(k,{modelValue:r.name,"onUpdate:modelValue":e[2]||(e[2]=l=>r.name=l)},null,8,["modelValue"])]),_:1}),a(v,{label:"Slug (URL)",name:"slug"},{default:s(()=>[a(k,{modelValue:r.slug,"onUpdate:modelValue":e[3]||(e[3]=l=>r.slug=l)},null,8,["modelValue"]),r.slug!==n.value?.slug?(p(),f("p",Me," ⚠ Cambiar el slug romperá enlaces existentes. ")):C("",!0)]),_:1}),a(v,{label:"Plan de Suscripción",name:"plan"},{default:s(()=>[a(E,{modelValue:r.plan_id,"onUpdate:modelValue":e[4]||(e[4]=l=>r.plan_id=l),options:A.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona un plan"},null,8,["modelValue","options"])]),_:1}),a(v,{label:"Estado",name:"status"},{default:s(()=>[a(E,{modelValue:r.status,"onUpdate:modelValue":e[5]||(e[5]=l=>r.status=l),options:[{label:"Activo",value:"active"},{label:"Suspendido",value:"suspended"}]},null,8,["modelValue"])]),_:1}),o("div",je,[a(d,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[6]||(e[6]=l=>V.value=!1)}),a(d,{type:"submit",color:"emerald",label:"Guardar Cambios",loading:T.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a($,{modelValue:x.value,"onUpdate:modelValue":e[15]||(e[15]=l=>x.value=l)},{default:s(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:s(()=>[o("div",ze,[o("h3",Ae,m(b.value?"Editar Usuario":"Nuevo Usuario"),1),a(d,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[8]||(e[8]=l=>x.value=!1)})])]),default:s(()=>[o("form",{onSubmit:j(Q,["prevent"]),class:"space-y-4 py-2"},[b.value?(p(),f("div",Pe,[e[28]||(e[28]=S(" Usuario: ",-1)),o("span",Oe,m(b.value.full_name||"Desconocido"),1)])):(p(),f("div",Ge,[a(v,{label:"Nombre Completo",name:"fullname",required:""},{default:s(()=>[a(k,{modelValue:i.full_name,"onUpdate:modelValue":e[9]||(e[9]=l=>i.full_name=l),icon:"i-heroicons-user"},null,8,["modelValue"])]),_:1}),a(v,{label:"Correo Electrónico",name:"email",required:""},{default:s(()=>[a(k,{modelValue:i.email,"onUpdate:modelValue":e[10]||(e[10]=l=>i.email=l),type:"email",icon:"i-heroicons-envelope"},null,8,["modelValue"])]),_:1}),a(v,{label:"Contraseña",name:"password",required:""},{default:s(()=>[a(k,{modelValue:i.password,"onUpdate:modelValue":e[11]||(e[11]=l=>i.password=l),type:"password",icon:"i-heroicons-lock-closed"},null,8,["modelValue"])]),_:1})])),a(v,{label:"Rol",name:"role"},{default:s(()=>[a(E,{modelValue:i.role,"onUpdate:modelValue":e[12]||(e[12]=l=>i.role=l),options:[{label:"Administrador",value:"admin"},{label:"Estilista",value:"stylist"}]},null,8,["modelValue"])]),_:1}),a(v,{label:"Sucursal Asignada",name:"branch"},{default:s(()=>[a(E,{modelValue:i.branch_id,"onUpdate:modelValue":e[13]||(e[13]=l=>i.branch_id=l),options:w.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una sucursal"},null,8,["modelValue","options"])]),_:1}),o("div",Re,[a(d,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[14]||(e[14]=l=>x.value=!1)}),a(d,{type:"submit",color:"emerald",label:b.value?"Guardar Cambios":"Crear Usuario",loading:D.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a($,{modelValue:y.value,"onUpdate:modelValue":e[20]||(e[20]=l=>y.value=l)},{default:s(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:s(()=>[o("div",Fe,[e[29]||(e[29]=o("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Nueva Sucursal",-1)),a(d,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[16]||(e[16]=l=>y.value=!1)})])]),default:s(()=>[o("form",{onSubmit:j(X,["prevent"]),class:"space-y-4 py-2"},[a(v,{label:"Nombre de Sucursal",name:"name"},{default:s(()=>[a(k,{modelValue:u.name,"onUpdate:modelValue":e[17]||(e[17]=l=>u.name=l),placeholder:"Ej: Centro"},null,8,["modelValue"])]),_:1}),a(v,{label:"Dirección",name:"address"},{default:s(()=>[a(k,{modelValue:u.address,"onUpdate:modelValue":e[18]||(e[18]=l=>u.address=l),icon:"i-heroicons-map-pin"},null,8,["modelValue"])]),_:1}),o("div",Ie,[a(d,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[19]||(e[19]=l=>y.value=!1)}),a(d,{type:"submit",color:"emerald",label:"Guardar",loading:B.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"])])}}});export{oa as default};
