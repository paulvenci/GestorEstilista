import{_ as de,b as ue}from"./CsXV8iS9.js";import{_ as ce}from"./BBD1JuDr.js";import{_ as me}from"./CW3LSVP2.js";import{_ as ve}from"./B_0R2G4_.js";import{a as pe,_ as fe}from"./ConUeM-o.js";import{_ as _e}from"./CNmWAGlu.js";import{_ as ge}from"./DLmJRcAx.js";import{e as be,p as xe,f as ye,a7 as he,G as ke,c as _,a as s,b as a,t as m,k as w,w as o,r as u,o as v,d as C,m as O,j as J,z as P,A as we,n as Ce}from"./CftujQzW.js";import"./C7GMWTSW.js";import"./DlAUqK2U.js";import"./V3j-_jrj.js";import"./CrhyU8fO.js";import"./SKO6gm_P.js";import"./B0e3kFy2.js";const Ve={class:"space-y-6"},Ue={class:"flex items-center justify-between"},Se={class:"flex items-center gap-4"},Ne={class:"hidden md:block"},Ee={key:0,class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},Be={key:1,class:"flex items-center gap-2 mt-1"},ze={class:"text-slate-500 text-sm"},Ie={class:"flex gap-3"},$e={key:0,class:"grid grid-cols-1 md:grid-cols-3 gap-6"},je={class:"flex flex-col"},Me={class:"text-2xl font-bold text-emerald-600"},qe={class:"flex flex-col"},Te={class:"text-2xl font-bold text-slate-900 dark:text-white"},De={class:"flex flex-col"},Ae={class:"text-2xl font-bold text-blue-600"},Oe={class:"space-y-4"},Je={class:"flex justify-between items-center"},Pe={key:1,class:"space-y-4"},Re={class:"flex justify-between items-center"},Ge={key:0},Fe={key:1,class:"text-xs text-slate-400"},He={class:"flex items-center justify-between"},Le={key:0,class:"text-xs text-red-500 mt-1"},Qe={class:"flex justify-end gap-3 mt-6"},Xe={class:"flex items-center justify-between"},Ze={class:"text-base font-semibold text-gray-900 dark:text-white"},We={key:0,class:"text-sm text-slate-500 mb-2"},Ye={class:"font-bold text-slate-900 dark:text-white"},Ke={key:1,class:"space-y-4"},ea={class:"flex justify-end gap-3 mt-6"},aa={class:"flex items-center justify-between"},la={class:"flex justify-end gap-3 mt-4"},ta={class:"flex items-center gap-2"},sa={class:"py-2 space-y-3"},oa={class:"text-sm text-slate-600 dark:text-slate-300"},na={class:"flex justify-end gap-3"},ka=be({__name:"[slug]",setup(ia){const F=xe(),p=ye(),H=he("headerTitle",()=>"Detalle");H.value="Detalle";const n=u(null),V=u([]),U=u(!1),M=u(!1),d=P({name:"",slug:"",status:"active",plan_id:null}),x=u(!1),q=u(!1),b=u(null),I=u([]),r=P({full_name:"",email:"",password:"",role:"stylist",branch_id:""}),E=u(!1),B=u(null),T=u(!1),D=we(()=>V.value.filter(t=>t.active).length),L=()=>{b.value=null,r.full_name="",r.email="",r.password="",r.role="stylist",r.branch_id="",x.value=!0},Q=()=>{const t=n.value?.plans?.max_users||999;if(I.value.length>=t){alert(`Has alcanzado el límite de ${t} usuario(s) del plan "${n.value?.plans?.name}". Mejora el plan para agregar más usuarios.`);return}L()},X=()=>{const t=n.value?.plans?.max_branches||1;if(D.value>=t){alert(`Has alcanzado el límite de ${t} sucursal(es) activa(s) del plan "${n.value?.plans?.name}". Mejora el plan para agregar más sucursales.`);return}N.value=null,c.name="",c.address="",y.value=!0},Z=t=>{B.value=t,E.value=!0},W=async()=>{if(B.value){T.value=!0;try{const{error:t}=await p.from("branches").update({active:!1}).eq("id",B.value.id);if(t)throw t;E.value=!1,B.value=null,await S(),alert("Sucursal eliminada correctamente.")}catch(t){alert("Error: "+t.message)}finally{T.value=!1}}},Y=async t=>{const e=n.value?.plans?.max_branches||1;if(D.value>=e){alert(`No puedes reactivar esta sucursal. Has alcanzado el límite de ${e} sucursal(es) activa(s) del plan.`);return}try{const{error:i}=await p.from("branches").update({active:!0}).eq("id",t.id);if(i)throw i;await S(),alert("Sucursal reactivada correctamente.")}catch(i){alert("Error: "+i.message)}},K=t=>{console.log("Editing user:",t),b.value=t,r.full_name=t.full_name,r.role=t.role,r.branch_id=t.branch_id,x.value=!0},ee=[{key:"full_name",label:"Nombre"},{key:"role",label:"Rol"},{key:"branch_id",label:"Sucursal"},{key:"actions",label:""}],R=u([]),ae=async()=>{const{data:t}=await p.from("plans").select("id, name");t&&(R.value=t)},S=async()=>{const t=F.params.slug,{data:e}=await p.from("tenants").select("*, plans(*)").eq("slug",t).single();if(e){n.value=e;const{data:i}=await p.from("branches").select("*").eq("tenant_id",e.id).order("is_main",{ascending:!1});i&&(V.value=i);const{data:h}=await p.from("profiles").select("*").eq("tenant_id",e.id);h&&(I.value=h)}},le=async()=>{if(n.value){M.value=!0;try{const{error:t}=await p.from("tenants").update({name:d.name,slug:d.slug,status:d.status,plan_id:d.plan_id}).eq("id",n.value.id);if(t)throw t;if(d.slug!==n.value.slug)return alert("Slug actualizado. Redirigiendo..."),Ce(`/admin/tenants/${d.slug}`);U.value=!1,await S(),alert("Negocio actualizado correctamente")}catch(t){alert("Error: "+t.message)}finally{M.value=!1}}},te=()=>{n.value&&(d.name=n.value.name,d.slug=n.value.slug,d.status=n.value.status,d.plan_id=n.value.plan_id,U.value=!0)};ke(()=>{S(),ae()});const y=u(!1),A=u(!1),c=P({name:"",address:""}),N=u(null),se=t=>{N.value=t.id,c.name=t.name,c.address=t.address,y.value=!0},oe=[{key:"name",label:"Nombre"},{key:"address",label:"Dirección"},{key:"is_main",label:"Tipo"},{key:"active",label:"Estado"},{key:"actions",label:""}],ne=async()=>{q.value=!0;try{if(b.value){const{error:t}=await p.from("profiles").update({role:r.role,branch_id:r.branch_id}).eq("id",b.value.id);if(t)throw t;alert("Usuario actualizado correctamente")}else{if(!n.value)throw new Error("Tenant context missing");const{data:{session:t}}=await p.auth.getSession();if(!t)throw new Error("No active session");const e=await $fetch("https://hupbcynenviknhwnhwxb.supabase.co/functions/v1/create-user",{method:"POST",headers:{Authorization:`Bearer ${t.access_token}`,apikey:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh1cGJjeW5lbnZpa25od25od3hiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA4NTQwMTQsImV4cCI6MjA4NjQzMDAxNH0.szIwHc18p3QcX6_EERNqrff8tgcag9-XNu1-wpIWk3E","Content-Type":"application/json"},body:{email:r.email,password:r.password,full_name:r.full_name,role:r.role,branch_id:r.branch_id||null,tenant_id:n.value.id}});alert("Usuario creado correctamente")}x.value=!1,await S()}catch(t){alert("Error: "+(t.statusMessage||t.message))}finally{q.value=!1}},ie=async()=>{if(n.value){A.value=!0;try{if(N.value){const{error:t}=await p.from("branches").update({name:c.name,address:c.address}).eq("id",N.value);if(t)throw t}else{const{error:t}=await p.from("branches").insert({tenant_id:n.value.id,name:c.name,address:c.address,is_main:!1});if(t)throw t}y.value=!1,c.name="",c.address="",N.value=null,await S(),alert(N.value?"Sucursal actualizada":"Sucursal creada")}catch(t){alert("Error: "+t.message)}finally{A.value=!1}}};return(t,e)=>{const i=de,h=ce,g=me,G=ve,k=fe,f=pe,$=_e,j=ge,re=ue;return v(),_("div",Ve,[s("div",Ue,[s("div",Se,[a(i,{icon:"i-heroicons-arrow-left",color:"gray",variant:"ghost",to:"/admin/tenants"}),s("div",Ne,[n.value?(v(),_("h1",Ee,m(n.value.name),1)):w("",!0),n.value?(v(),_("div",Be,[a(h,{color:n.value.status==="active"?"emerald":"red",variant:"subtle"},{default:o(()=>[C(m(n.value.status==="active"?"Activo":"Suspendido"),1)]),_:1},8,["color"]),s("span",ze,m(n.value.slug),1)])):w("",!0)])]),s("div",Ie,[a(i,{label:"Editar Negocio",icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",onClick:te})])]),n.value?(v(),_("div",$e,[a(g,null,{default:o(()=>[s("div",je,[e[22]||(e[22]=s("span",{class:"text-sm text-slate-500 font-medium"},"Plan Actual",-1)),s("span",Me,m(n.value.plans?.name||"Sin Plan"),1)])]),_:1}),a(g,null,{default:o(()=>[s("div",qe,[e[23]||(e[23]=s("span",{class:"text-sm text-slate-500 font-medium"},"Próximo Pago",-1)),s("span",Te,m(n.value.next_billing_date?new Date(n.value.next_billing_date).toLocaleDateString():"N/A"),1)])]),_:1}),a(g,null,{default:o(()=>[s("div",De,[e[24]||(e[24]=s("span",{class:"text-sm text-slate-500 font-medium"},"Sucursales",-1)),s("span",Ae,m(D.value)+" / "+m(n.value.plans?.max_branches||1),1)])]),_:1})])):w("",!0),s("div",Oe,[s("div",Je,[e[25]||(e[25]=s("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Sucursales",-1)),a(i,{label:"Nueva Sucursal",icon:"i-heroicons-plus",color:"emerald",size:"sm",onClick:X})]),a(g,{ui:{body:{padding:"p-0"}}},{default:o(()=>[a(G,{rows:V.value,columns:oe},{"is_main-data":o(({row:l})=>[l.is_main?(v(),O(h,{key:0,color:"blue",variant:"subtle"},{default:o(()=>[...e[26]||(e[26]=[C("Casa Matriz",-1)])]),_:1})):w("",!0)]),"active-data":o(({row:l})=>[a(h,{color:l.active?"emerald":"gray",variant:"subtle"},{default:o(()=>[C(m(l.active?"Operativa":"Cerrada"),1)]),_:2},1032,["color"])]),"actions-data":o(({row:l})=>[a(i,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:z=>se(l)},null,8,["onClick"]),l.active&&!l.is_main?(v(),O(i,{key:0,icon:"i-heroicons-trash",color:"red",variant:"ghost",size:"xs",onClick:z=>Z(l)},null,8,["onClick"])):w("",!0),l.active?w("",!0):(v(),O(i,{key:1,icon:"i-heroicons-arrow-path",color:"emerald",variant:"ghost",size:"xs",title:"Reactivar sucursal",onClick:z=>Y(l)},null,8,["onClick"]))]),_:1},8,["rows"])]),_:1})]),(I.value.length>0,v(),_("div",Pe,[s("div",Re,[e[27]||(e[27]=s("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Usuarios",-1)),a(i,{label:"Nuevo Usuario",icon:"i-heroicons-user-plus",color:"emerald",size:"sm",onClick:Q})]),a(g,{ui:{body:{padding:"p-0"}}},{default:o(()=>[a(G,{rows:I.value,columns:ee},{"role-data":o(({row:l})=>[a(h,{color:l.role==="admin"?"purple":"blue",variant:"subtle"},{default:o(()=>[C(m(l.role==="admin"?"Administrador":"Estilista"),1)]),_:2},1032,["color"])]),"branch_id-data":o(({row:l})=>[V.value.length>0?(v(),_("span",Ge,m(V.value.find(z=>z.id===l.branch_id)?.name||"Sin Asignar"),1)):(v(),_("span",Fe,"Cargando..."))]),"actions-data":o(({row:l})=>[a(i,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:z=>K(l)},null,8,["onClick"])]),_:1},8,["rows"])]),_:1})])),a(j,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=l=>U.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",He,[e[28]||(e[28]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Editar Negocio",-1)),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[0]||(e[0]=l=>U.value=!1)})])]),default:o(()=>[s("form",{onSubmit:J(le,["prevent"]),class:"space-y-4 py-2"},[a(f,{label:"Nombre del Negocio",name:"name"},{default:o(()=>[a(k,{modelValue:d.name,"onUpdate:modelValue":e[1]||(e[1]=l=>d.name=l)},null,8,["modelValue"])]),_:1}),a(f,{label:"Slug (URL)",name:"slug"},{default:o(()=>[a(k,{modelValue:d.slug,"onUpdate:modelValue":e[2]||(e[2]=l=>d.slug=l)},null,8,["modelValue"]),d.slug!==n.value?.slug?(v(),_("p",Le," ⚠ Cambiar el slug romperá enlaces existentes. ")):w("",!0)]),_:1}),a(f,{label:"Plan de Suscripción",name:"plan"},{default:o(()=>[a($,{modelValue:d.plan_id,"onUpdate:modelValue":e[3]||(e[3]=l=>d.plan_id=l),options:R.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona un plan"},null,8,["modelValue","options"])]),_:1}),a(f,{label:"Estado",name:"status"},{default:o(()=>[a($,{modelValue:d.status,"onUpdate:modelValue":e[4]||(e[4]=l=>d.status=l),options:[{label:"Activo",value:"active"},{label:"Suspendido",value:"suspended"}]},null,8,["modelValue"])]),_:1}),s("div",Qe,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[5]||(e[5]=l=>U.value=!1)}),a(i,{type:"submit",color:"emerald",label:"Guardar Cambios",loading:M.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(j,{modelValue:x.value,"onUpdate:modelValue":e[14]||(e[14]=l=>x.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",Xe,[s("h3",Ze,m(b.value?"Editar Usuario":"Nuevo Usuario"),1),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[7]||(e[7]=l=>x.value=!1)})])]),default:o(()=>[s("form",{onSubmit:J(ne,["prevent"]),class:"space-y-4 py-2"},[b.value?(v(),_("div",We,[e[29]||(e[29]=C(" Usuario: ",-1)),s("span",Ye,m(b.value.full_name||"Desconocido"),1)])):(v(),_("div",Ke,[a(f,{label:"Nombre Completo",name:"fullname",required:""},{default:o(()=>[a(k,{modelValue:r.full_name,"onUpdate:modelValue":e[8]||(e[8]=l=>r.full_name=l),icon:"i-heroicons-user"},null,8,["modelValue"])]),_:1}),a(f,{label:"Correo Electrónico",name:"email",required:""},{default:o(()=>[a(k,{modelValue:r.email,"onUpdate:modelValue":e[9]||(e[9]=l=>r.email=l),type:"email",icon:"i-heroicons-envelope"},null,8,["modelValue"])]),_:1}),a(f,{label:"Contraseña",name:"password",required:""},{default:o(()=>[a(k,{modelValue:r.password,"onUpdate:modelValue":e[10]||(e[10]=l=>r.password=l),type:"password",icon:"i-heroicons-lock-closed"},null,8,["modelValue"])]),_:1})])),a(f,{label:"Rol",name:"role"},{default:o(()=>[a($,{modelValue:r.role,"onUpdate:modelValue":e[11]||(e[11]=l=>r.role=l),options:[{label:"Administrador",value:"admin"},{label:"Estilista",value:"stylist"}]},null,8,["modelValue"])]),_:1}),a(f,{label:"Sucursal Asignada",name:"branch"},{default:o(()=>[a($,{modelValue:r.branch_id,"onUpdate:modelValue":e[12]||(e[12]=l=>r.branch_id=l),options:V.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una sucursal"},null,8,["modelValue","options"])]),_:1}),s("div",ea,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[13]||(e[13]=l=>x.value=!1)}),a(i,{type:"submit",color:"emerald",label:b.value?"Guardar Cambios":"Crear Usuario",loading:q.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(j,{modelValue:y.value,"onUpdate:modelValue":e[19]||(e[19]=l=>y.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",aa,[e[30]||(e[30]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Nueva Sucursal",-1)),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[15]||(e[15]=l=>y.value=!1)})])]),default:o(()=>[s("form",{onSubmit:J(ie,["prevent"]),class:"space-y-4 py-2"},[a(f,{label:"Nombre de Sucursal",name:"name"},{default:o(()=>[a(k,{modelValue:c.name,"onUpdate:modelValue":e[16]||(e[16]=l=>c.name=l),placeholder:"Ej: Centro"},null,8,["modelValue"])]),_:1}),a(f,{label:"Dirección",name:"address"},{default:o(()=>[a(k,{modelValue:c.address,"onUpdate:modelValue":e[17]||(e[17]=l=>c.address=l),icon:"i-heroicons-map-pin"},null,8,["modelValue"])]),_:1}),s("div",la,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[18]||(e[18]=l=>y.value=!1)}),a(i,{type:"submit",color:"emerald",label:"Guardar",loading:A.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(j,{modelValue:E.value,"onUpdate:modelValue":e[21]||(e[21]=l=>E.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",ta,[a(re,{name:"i-heroicons-exclamation-triangle",class:"w-5 h-5 text-red-500"}),e[31]||(e[31]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Eliminar Sucursal",-1))])]),footer:o(()=>[s("div",na,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[20]||(e[20]=l=>E.value=!1)}),a(i,{color:"red",label:"Eliminar",icon:"i-heroicons-trash",loading:T.value,onClick:W},null,8,["loading"])])]),default:o(()=>[s("div",sa,[s("p",oa,[e[32]||(e[32]=C(" ¿Estás seguro de que quieres eliminar la sucursal ",-1)),s("strong",null,'"'+m(B.value?.name)+'"',1),e[33]||(e[33]=C("? ",-1))]),e[34]||(e[34]=s("p",{class:"text-xs text-slate-400"}," La sucursal será desactivada. Podrás reactivarla más adelante si lo necesitas. ",-1))])]),_:1})]),_:1},8,["modelValue"])])}}});export{ka as default};
