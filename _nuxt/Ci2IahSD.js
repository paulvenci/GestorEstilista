import{b as K,_ as Q}from"./B5me2haN.js";import{_ as W}from"./B6BkTIS0.js";import{_ as X}from"./-HABD6Ae.js";import{a as Y,_ as Z}from"./BBSTtyTp.js";import{_ as ee}from"./CfnJ_uRK.js";import{_ as ae}from"./B2xe3f_O.js";import{e as te,f as se,a7 as D,a8 as le,q as oe,G as re,c as N,a,h as V,m as x,k as g,b as r,d as f,t as _,F as ne,s as ie,w as i,r as v,A as ue,o as c,y as O,j as de,z as ce}from"./BoyDVv4J.js";import"./D6vku3W2.js";import"./DlAUqK2U.js";import"./CzwcVY_m.js";import"./BZKOFq6c.js";import"./DjvB_zsV.js";import"./CjduMhnr.js";const me={class:"space-y-6"},ve={class:"flex justify-between items-center"},pe={key:0,class:"flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800/50 rounded-lg px-4 py-2"},fe={class:"text-slate-700 dark:text-white"},_e={class:"text-slate-700 dark:text-white"},xe={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"},ge={class:"flex justify-between items-start"},he={class:"text-lg font-bold text-slate-900 dark:text-white"},ye={class:"text-sm text-slate-500 flex items-center gap-1 mt-1"},we={class:"flex gap-1"},ke={class:"flex justify-between items-center mt-4"},be={class:"flex flex-col"},Ce={class:"flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"},Ve={class:"flex items-center justify-between"},Se={class:"text-base font-semibold text-gray-900 dark:text-white"},Ue={class:"flex items-center justify-between"},Ee={class:"flex justify-end gap-3 mt-6"},ze={class:"flex items-center gap-2"},Be={class:"py-2 space-y-3"},$e={class:"text-sm text-slate-600 dark:text-slate-300"},qe={class:"flex justify-end gap-3"},Je=te({__name:"sucursales",setup(je){const d=se(),F=D("headerTitle",()=>"Sucursales");F.value="Sucursales";const S=le(),b=D("userRole",()=>null),U=v([]),h=v(!1),y=v(!1),E=v(!1),z=v(!1),m=v(null),w=v(null),n=v(null),p=v(null),o=ce({name:"",address:"",phone:"",active:!0}),C=ue(()=>U.value.filter(t=>t.active).length),k=async()=>{let t=S.value?.id;if(!t){const{data:{session:u}}=await d.auth.getSession();u?.user&&(t=u.user.id)}if(!t)return;if(!p.value){const{data:u}=await d.from("profiles").select("tenant_id").eq("id",t).single();u&&(p.value=u.tenant_id)}if(p.value&&!n.value){const{data:u}=await d.from("tenants").select("plan_id, plans ( name, max_users, max_branches )").eq("id",p.value).single();u?.plans&&(n.value=u.plans)}const{data:e,error:l}=await d.from("branches").select("*").order("is_main",{ascending:!1}).order("created_at",{ascending:!0});if(l){console.error("Error fetching branches:",l);return}e&&(U.value=e)};oe(S,()=>{k()},{immediate:!0});const G=()=>{if(n.value&&C.value>=n.value.max_branches){alert(`Has alcanzado el límite de ${n.value.max_branches} sucursal(es) activa(s) de tu plan "${n.value.name}". Mejora tu plan para agregar más sucursales.`);return}m.value=null,o.name="",o.address="",o.phone="",o.active=!0,h.value=!0},L=async()=>{E.value=!0;try{let t=S.value?.id;if(!t){const{data:{session:l}}=await d.auth.getSession();l?.user&&(t=l.user.id)}if(!t)throw new Error("Usuario no autenticado");if(!p.value){const{data:l}=await d.from("profiles").select("tenant_id").eq("id",t).single();l&&(p.value=l.tenant_id)}if(!p.value)throw new Error("No se encontró perfil de usuario");if(!m.value&&n.value&&C.value>=n.value.max_branches)throw new Error(`Límite de sucursales alcanzado (${n.value.max_branches}) para tu plan "${n.value.name}".`);const e={...o,tenant_id:p.value};if(m.value){const{error:l}=await d.from("branches").update(e).eq("id",m.value);if(l)throw l}else{const{error:l}=await d.from("branches").insert(e);if(l)throw l}B(),await k(),alert(m.value?"Sucursal actualizada":"Sucursal creada")}catch(t){alert("Error: "+t.message)}finally{E.value=!1}},R=t=>{m.value=t.id,o.name=t.name,o.address=t.address,o.phone=t.phone,o.active=t.active,h.value=!0},A=t=>{w.value=t,y.value=!0},H=async()=>{if(w.value){z.value=!0;try{const{error:t}=await d.from("branches").update({active:!1}).eq("id",w.value.id);if(t)throw t;y.value=!1,w.value=null,await k(),alert("Sucursal eliminada correctamente.")}catch(t){alert("Error: "+t.message)}finally{z.value=!1}}},P=async t=>{if(n.value&&C.value>=n.value.max_branches){alert(`No puedes reactivar esta sucursal. Has alcanzado el límite de ${n.value.max_branches} sucursal(es) activa(s) de tu plan "${n.value.name}".`);return}try{const{error:e}=await d.from("branches").update({active:!0}).eq("id",t.id);if(e)throw e;await k(),alert("Sucursal reactivada correctamente.")}catch(e){alert("Error: "+e.message)}},B=()=>{h.value=!1,m.value=null,o.name="",o.address="",o.phone="",o.active=!0};return re(()=>{k()}),(t,e)=>{const l=Q,u=K,I=W,$=X,q=Z,j=Y,J=ee,M=ae;return c(),N("div",me,[a("div",ve,[e[7]||(e[7]=a("div",{class:"hidden md:block"},[a("h1",{class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},"Sucursales"),a("p",{class:"text-slate-500 dark:text-slate-400 mt-1"},"Gestiona las sedes de tu negocio.")],-1)),V(b)==="superadmin"?(c(),x(l,{key:0,label:"Nueva Sucursal",icon:"i-heroicons-plus",color:"emerald",size:"lg",onClick:G,class:"shadow-lg shadow-emerald-500/20"})):g("",!0)]),n.value?(c(),N("div",pe,[r(u,{name:"i-heroicons-information-circle",class:"w-5 h-5 text-emerald-500"}),a("span",null,[e[8]||(e[8]=f("Sucursales activas: ",-1)),a("strong",fe,_(C.value),1),e[9]||(e[9]=f(" / ",-1)),a("strong",_e,_(n.value.max_branches),1),f(" ("+_(n.value.name)+")",1)])])):g("",!0),a("div",xe,[(c(!0),N(ne,null,ie(U.value,s=>(c(),x($,{key:s.id,class:O(["relative overflow-hidden group transition-all duration-300",s.active?"border-t-4 border-t-emerald-500":"border-t-4 border-t-red-400 opacity-60"])},{header:i(()=>[a("div",ge,[a("div",null,[a("h3",he,_(s.name),1),a("p",ye,[r(u,{name:"i-heroicons-map-pin",class:"w-4 h-4"}),f(" "+_(s.address||"Sin dirección"),1)])]),a("div",we,[s.is_main?(c(),x(I,{key:0,color:"blue",variant:"subtle"},{default:i(()=>[...e[10]||(e[10]=[f("Matriz",-1)])]),_:1})):g("",!0),s.active?g("",!0):(c(),x(I,{key:1,color:"red",variant:"subtle"},{default:i(()=>[...e[11]||(e[11]=[f("Eliminada",-1)])]),_:1}))])])]),default:i(()=>[a("div",ke,[a("div",be,[e[12]||(e[12]=a("span",{class:"text-xs text-slate-400 font-medium uppercase"},"Estado",-1)),a("span",{class:O([s.active?"text-emerald-500":"text-red-500","font-bold"])},_(s.active?"Operativa":"Cerrada"),3)]),a("div",Ce,[V(b)==="superadmin"?(c(),x(l,{key:0,icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:T=>R(s)},null,8,["onClick"])):g("",!0),V(b)==="superadmin"&&s.active&&!s.is_main?(c(),x(l,{key:1,icon:"i-heroicons-trash",color:"red",variant:"ghost",size:"xs",onClick:T=>A(s)},null,8,["onClick"])):g("",!0),V(b)==="superadmin"&&!s.active?(c(),x(l,{key:2,icon:"i-heroicons-arrow-path",color:"emerald",variant:"ghost",size:"xs",title:"Reactivar sucursal",onClick:T=>P(s)},null,8,["onClick"])):g("",!0)])])]),_:2},1032,["class"]))),128))]),r(M,{modelValue:h.value,"onUpdate:modelValue":e[4]||(e[4]=s=>h.value=s)},{default:i(()=>[r($,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:i(()=>[a("div",Ve,[a("h3",Se,_(m.value?"Editar Sucursal":"Nueva Sucursal"),1),r(l,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:B})])]),default:i(()=>[a("form",{onSubmit:de(L,["prevent"]),class:"space-y-4 py-2"},[r(j,{label:"Nombre",name:"name",required:""},{default:i(()=>[r(q,{modelValue:o.name,"onUpdate:modelValue":e[0]||(e[0]=s=>o.name=s),placeholder:"Ej: Centro, Norte, Plaza",icon:"i-heroicons-building-storefront"},null,8,["modelValue"])]),_:1}),r(j,{label:"Dirección",name:"address"},{default:i(()=>[r(q,{modelValue:o.address,"onUpdate:modelValue":e[1]||(e[1]=s=>o.address=s),icon:"i-heroicons-map-pin"},null,8,["modelValue"])]),_:1}),r(j,{label:"Teléfono",name:"phone"},{default:i(()=>[r(q,{modelValue:o.phone,"onUpdate:modelValue":e[2]||(e[2]=s=>o.phone=s),icon:"i-heroicons-phone"},null,8,["modelValue"])]),_:1}),a("div",Ue,[e[13]||(e[13]=a("span",{class:"text-sm text-gray-700 dark:text-gray-200"},"Sucursal Operativa",-1)),r(J,{modelValue:o.active,"onUpdate:modelValue":e[3]||(e[3]=s=>o.active=s)},null,8,["modelValue"])]),a("div",Ee,[r(l,{color:"gray",variant:"ghost",label:"Cancelar",onClick:B}),r(l,{type:"submit",color:"emerald",label:m.value?"Actualizar":"Crear",loading:E.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),r(M,{modelValue:y.value,"onUpdate:modelValue":e[6]||(e[6]=s=>y.value=s)},{default:i(()=>[r($,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:i(()=>[a("div",ze,[r(u,{name:"i-heroicons-exclamation-triangle",class:"w-5 h-5 text-red-500"}),e[14]||(e[14]=a("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Eliminar Sucursal",-1))])]),footer:i(()=>[a("div",qe,[r(l,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[5]||(e[5]=s=>y.value=!1)}),r(l,{color:"red",label:"Eliminar",icon:"i-heroicons-trash",loading:z.value,onClick:H},null,8,["loading"])])]),default:i(()=>[a("div",Be,[a("p",$e,[e[15]||(e[15]=f(" ¿Estás seguro de que quieres eliminar la sucursal ",-1)),a("strong",null,'"'+_(w.value?.name)+'"',1),e[16]||(e[16]=f("? ",-1))]),e[17]||(e[17]=a("p",{class:"text-xs text-slate-400"}," La sucursal será desactivada y no aparecerá para los usuarios. Podrás reactivarla más adelante si lo necesitas. ",-1))])]),_:1})]),_:1},8,["modelValue"])])}}});export{Je as default};
