import{_ as de,b as ue}from"./B5me2haN.js";import{_ as ce}from"./B6BkTIS0.js";import{_ as me}from"./-HABD6Ae.js";import{_ as ve}from"./DeqT5uMM.js";import{a as pe,_ as fe}from"./BBSTtyTp.js";import{_ as _e}from"./CMNeP-Ww.js";import{_ as ge}from"./B2xe3f_O.js";import{e as be,p as xe,f as ye,a7 as he,G as ke,c as _,a as s,b as a,t as m,k as w,w as o,r as u,o as v,d as V,m as O,j as R,z as G,A as we,n as Ve}from"./BoyDVv4J.js";import"./D6vku3W2.js";import"./DlAUqK2U.js";import"./CzwcVY_m.js";import"./BVhQNc7P.js";import"./B_tjyVtb.js";import"./DjvB_zsV.js";const Ce={class:"space-y-6"},Ue={class:"flex items-center justify-between"},Se={class:"flex items-center gap-4"},Be={class:"hidden md:block"},Ee={key:0,class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},Ne={key:1,class:"flex items-center gap-2 mt-1"},$e={class:"text-slate-500 text-sm"},qe={class:"flex gap-3"},ze={key:0,class:"grid grid-cols-1 md:grid-cols-3 gap-6"},De={class:"flex flex-col"},je={class:"text-2xl font-bold text-emerald-600"},Me={class:"flex flex-col"},Te={class:"text-2xl font-bold text-slate-900 dark:text-white"},Ae={class:"flex flex-col"},Pe={class:"text-2xl font-bold text-blue-600"},Oe={class:"space-y-4"},Re={class:"flex justify-between items-center"},Ge={key:1,class:"space-y-4"},Le={class:"flex justify-between items-center"},Fe={key:0},He={key:1,class:"text-xs text-slate-400"},Ie={class:"flex items-center justify-between"},Je={key:0,class:"text-xs text-red-500 mt-1"},Ke={class:"flex justify-end gap-3 mt-6"},Qe={class:"flex items-center justify-between"},We={class:"text-base font-semibold text-gray-900 dark:text-white"},Xe={key:0,class:"text-sm text-slate-500 mb-2"},Ye={class:"font-bold text-slate-900 dark:text-white"},Ze={key:1,class:"space-y-4"},ea={class:"flex justify-end gap-3 mt-6"},aa={class:"flex items-center justify-between"},la={class:"flex justify-end gap-3 mt-4"},ta={class:"flex items-center gap-2"},sa={class:"py-2 space-y-3"},oa={class:"text-sm text-slate-600 dark:text-slate-300"},na={class:"flex justify-end gap-3"},ka=be({__name:"[slug]",setup(ia){const H=xe(),f=ye(),I=he("headerTitle",()=>"Detalle");I.value="Detalle";const n=u(null),C=u([]),U=u(!1),j=u(!1),d=G({name:"",slug:"",status:"active",plan_id:null}),x=u(!1),M=u(!1),b=u(null),q=u([]),r=G({full_name:"",email:"",password:"",role:"stylist",branch_id:""}),E=u(!1),N=u(null),T=u(!1),A=we(()=>C.value.filter(t=>t.active).length),J=()=>{b.value=null,r.full_name="",r.email="",r.password="",r.role="stylist",r.branch_id="",x.value=!0},K=()=>{const t=n.value?.plans?.max_users||999;if(q.value.length>=t){alert(`Has alcanzado el límite de ${t} usuario(s) del plan "${n.value?.plans?.name}". Mejora el plan para agregar más usuarios.`);return}J()},Q=()=>{const t=n.value?.plans?.max_branches||1;if(A.value>=t){alert(`Has alcanzado el límite de ${t} sucursal(es) activa(s) del plan "${n.value?.plans?.name}". Mejora el plan para agregar más sucursales.`);return}B.value=null,c.name="",c.address="",y.value=!0},W=t=>{N.value=t,E.value=!0},X=async()=>{if(N.value){T.value=!0;try{const{error:t}=await f.from("branches").update({active:!1}).eq("id",N.value.id);if(t)throw t;E.value=!1,N.value=null,await S(),alert("Sucursal eliminada correctamente.")}catch(t){alert("Error: "+t.message)}finally{T.value=!1}}},Y=async t=>{const e=n.value?.plans?.max_branches||1;if(A.value>=e){alert(`No puedes reactivar esta sucursal. Has alcanzado el límite de ${e} sucursal(es) activa(s) del plan.`);return}try{const{error:i}=await f.from("branches").update({active:!0}).eq("id",t.id);if(i)throw i;await S(),alert("Sucursal reactivada correctamente.")}catch(i){alert("Error: "+i.message)}},Z=t=>{console.log("Editing user:",t),b.value=t,r.full_name=t.full_name,r.role=t.role,r.branch_id=t.branch_id,x.value=!0},ee=[{key:"full_name",label:"Nombre"},{key:"role",label:"Rol"},{key:"branch_id",label:"Sucursal"},{key:"actions",label:""}],L=u([]),ae=async()=>{const{data:t}=await f.from("plans").select("id, name");t&&(L.value=t)},S=async()=>{const t=H.params.slug,{data:e}=await f.from("tenants").select("*, plans(*)").eq("slug",t).single();if(e){n.value=e;const{data:i}=await f.from("branches").select("*").eq("tenant_id",e.id).order("is_main",{ascending:!1});i&&(C.value=i);const{data:h}=await f.from("profiles").select("*").eq("tenant_id",e.id);h&&(q.value=h)}},le=async()=>{if(n.value){j.value=!0;try{const{error:t}=await f.from("tenants").update({name:d.name,slug:d.slug,status:d.status,plan_id:d.plan_id}).eq("id",n.value.id);if(t)throw t;if(d.slug!==n.value.slug)return alert("Slug actualizado. Redirigiendo..."),Ve(`/admin/tenants/${d.slug}`);U.value=!1,await S(),alert("Negocio actualizado correctamente")}catch(t){alert("Error: "+t.message)}finally{j.value=!1}}},te=()=>{n.value&&(d.name=n.value.name,d.slug=n.value.slug,d.status=n.value.status,d.plan_id=n.value.plan_id,U.value=!0)};ke(()=>{S(),ae()});const y=u(!1),P=u(!1),c=G({name:"",address:""}),B=u(null),se=t=>{B.value=t.id,c.name=t.name,c.address=t.address,y.value=!0},oe=[{key:"name",label:"Nombre"},{key:"address",label:"Dirección"},{key:"is_main",label:"Tipo"},{key:"active",label:"Estado"},{key:"actions",label:""}],ne=async()=>{M.value=!0;try{if(b.value){const{error:t}=await f.from("profiles").update({role:r.role,branch_id:r.branch_id}).eq("id",b.value.id);if(t)throw t;alert("Usuario actualizado correctamente")}else{if(!n.value)throw new Error("Tenant context missing");const t=await $fetch("/api/admin/users",{method:"POST",body:{email:r.email,password:r.password,full_name:r.full_name,role:r.role,branch_id:r.branch_id||null,tenant_id:n.value.id}});alert("Usuario creado correctamente")}x.value=!1,await S()}catch(t){alert("Error: "+(t.statusMessage||t.message))}finally{M.value=!1}},ie=async()=>{if(n.value){P.value=!0;try{if(B.value){const{error:t}=await f.from("branches").update({name:c.name,address:c.address}).eq("id",B.value);if(t)throw t}else{const{error:t}=await f.from("branches").insert({tenant_id:n.value.id,name:c.name,address:c.address,is_main:!1});if(t)throw t}y.value=!1,c.name="",c.address="",B.value=null,await S(),alert(B.value?"Sucursal actualizada":"Sucursal creada")}catch(t){alert("Error: "+t.message)}finally{P.value=!1}}};return(t,e)=>{const i=de,h=ce,g=me,F=ve,k=fe,p=pe,z=_e,D=ge,re=ue;return v(),_("div",Ce,[s("div",Ue,[s("div",Se,[a(i,{icon:"i-heroicons-arrow-left",color:"gray",variant:"ghost",to:"/admin/tenants"}),s("div",Be,[n.value?(v(),_("h1",Ee,m(n.value.name),1)):w("",!0),n.value?(v(),_("div",Ne,[a(h,{color:n.value.status==="active"?"emerald":"red",variant:"subtle"},{default:o(()=>[V(m(n.value.status==="active"?"Activo":"Suspendido"),1)]),_:1},8,["color"]),s("span",$e,m(n.value.slug),1)])):w("",!0)])]),s("div",qe,[a(i,{label:"Editar Negocio",icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",onClick:te})])]),n.value?(v(),_("div",ze,[a(g,null,{default:o(()=>[s("div",De,[e[22]||(e[22]=s("span",{class:"text-sm text-slate-500 font-medium"},"Plan Actual",-1)),s("span",je,m(n.value.plans?.name||"Sin Plan"),1)])]),_:1}),a(g,null,{default:o(()=>[s("div",Me,[e[23]||(e[23]=s("span",{class:"text-sm text-slate-500 font-medium"},"Próximo Pago",-1)),s("span",Te,m(n.value.next_billing_date?new Date(n.value.next_billing_date).toLocaleDateString():"N/A"),1)])]),_:1}),a(g,null,{default:o(()=>[s("div",Ae,[e[24]||(e[24]=s("span",{class:"text-sm text-slate-500 font-medium"},"Sucursales",-1)),s("span",Pe,m(A.value)+" / "+m(n.value.plans?.max_branches||1),1)])]),_:1})])):w("",!0),s("div",Oe,[s("div",Re,[e[25]||(e[25]=s("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Sucursales",-1)),a(i,{label:"Nueva Sucursal",icon:"i-heroicons-plus",color:"emerald",size:"sm",onClick:Q})]),a(g,{ui:{body:{padding:"p-0"}}},{default:o(()=>[a(F,{rows:C.value,columns:oe},{"is_main-data":o(({row:l})=>[l.is_main?(v(),O(h,{key:0,color:"blue",variant:"subtle"},{default:o(()=>[...e[26]||(e[26]=[V("Casa Matriz",-1)])]),_:1})):w("",!0)]),"active-data":o(({row:l})=>[a(h,{color:l.active?"emerald":"gray",variant:"subtle"},{default:o(()=>[V(m(l.active?"Operativa":"Cerrada"),1)]),_:2},1032,["color"])]),"actions-data":o(({row:l})=>[a(i,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:$=>se(l)},null,8,["onClick"]),l.active&&!l.is_main?(v(),O(i,{key:0,icon:"i-heroicons-trash",color:"red",variant:"ghost",size:"xs",onClick:$=>W(l)},null,8,["onClick"])):w("",!0),l.active?w("",!0):(v(),O(i,{key:1,icon:"i-heroicons-arrow-path",color:"emerald",variant:"ghost",size:"xs",title:"Reactivar sucursal",onClick:$=>Y(l)},null,8,["onClick"]))]),_:1},8,["rows"])]),_:1})]),(q.value.length>0,v(),_("div",Ge,[s("div",Le,[e[27]||(e[27]=s("h2",{class:"text-xl font-bold text-slate-900 dark:text-white"},"Usuarios",-1)),a(i,{label:"Nuevo Usuario",icon:"i-heroicons-user-plus",color:"emerald",size:"sm",onClick:K})]),a(g,{ui:{body:{padding:"p-0"}}},{default:o(()=>[a(F,{rows:q.value,columns:ee},{"role-data":o(({row:l})=>[a(h,{color:l.role==="admin"?"purple":"blue",variant:"subtle"},{default:o(()=>[V(m(l.role==="admin"?"Administrador":"Estilista"),1)]),_:2},1032,["color"])]),"branch_id-data":o(({row:l})=>[C.value.length>0?(v(),_("span",Fe,m(C.value.find($=>$.id===l.branch_id)?.name||"Sin Asignar"),1)):(v(),_("span",He,"Cargando..."))]),"actions-data":o(({row:l})=>[a(i,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:$=>Z(l)},null,8,["onClick"])]),_:1},8,["rows"])]),_:1})])),a(D,{modelValue:U.value,"onUpdate:modelValue":e[6]||(e[6]=l=>U.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",Ie,[e[28]||(e[28]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Editar Negocio",-1)),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[0]||(e[0]=l=>U.value=!1)})])]),default:o(()=>[s("form",{onSubmit:R(le,["prevent"]),class:"space-y-4 py-2"},[a(p,{label:"Nombre del Negocio",name:"name"},{default:o(()=>[a(k,{modelValue:d.name,"onUpdate:modelValue":e[1]||(e[1]=l=>d.name=l)},null,8,["modelValue"])]),_:1}),a(p,{label:"Slug (URL)",name:"slug"},{default:o(()=>[a(k,{modelValue:d.slug,"onUpdate:modelValue":e[2]||(e[2]=l=>d.slug=l)},null,8,["modelValue"]),d.slug!==n.value?.slug?(v(),_("p",Je," ⚠ Cambiar el slug romperá enlaces existentes. ")):w("",!0)]),_:1}),a(p,{label:"Plan de Suscripción",name:"plan"},{default:o(()=>[a(z,{modelValue:d.plan_id,"onUpdate:modelValue":e[3]||(e[3]=l=>d.plan_id=l),options:L.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona un plan"},null,8,["modelValue","options"])]),_:1}),a(p,{label:"Estado",name:"status"},{default:o(()=>[a(z,{modelValue:d.status,"onUpdate:modelValue":e[4]||(e[4]=l=>d.status=l),options:[{label:"Activo",value:"active"},{label:"Suspendido",value:"suspended"}]},null,8,["modelValue"])]),_:1}),s("div",Ke,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[5]||(e[5]=l=>U.value=!1)}),a(i,{type:"submit",color:"emerald",label:"Guardar Cambios",loading:j.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(D,{modelValue:x.value,"onUpdate:modelValue":e[14]||(e[14]=l=>x.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",Qe,[s("h3",We,m(b.value?"Editar Usuario":"Nuevo Usuario"),1),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[7]||(e[7]=l=>x.value=!1)})])]),default:o(()=>[s("form",{onSubmit:R(ne,["prevent"]),class:"space-y-4 py-2"},[b.value?(v(),_("div",Xe,[e[29]||(e[29]=V(" Usuario: ",-1)),s("span",Ye,m(b.value.full_name||"Desconocido"),1)])):(v(),_("div",Ze,[a(p,{label:"Nombre Completo",name:"fullname",required:""},{default:o(()=>[a(k,{modelValue:r.full_name,"onUpdate:modelValue":e[8]||(e[8]=l=>r.full_name=l),icon:"i-heroicons-user"},null,8,["modelValue"])]),_:1}),a(p,{label:"Correo Electrónico",name:"email",required:""},{default:o(()=>[a(k,{modelValue:r.email,"onUpdate:modelValue":e[9]||(e[9]=l=>r.email=l),type:"email",icon:"i-heroicons-envelope"},null,8,["modelValue"])]),_:1}),a(p,{label:"Contraseña",name:"password",required:""},{default:o(()=>[a(k,{modelValue:r.password,"onUpdate:modelValue":e[10]||(e[10]=l=>r.password=l),type:"password",icon:"i-heroicons-lock-closed"},null,8,["modelValue"])]),_:1})])),a(p,{label:"Rol",name:"role"},{default:o(()=>[a(z,{modelValue:r.role,"onUpdate:modelValue":e[11]||(e[11]=l=>r.role=l),options:[{label:"Administrador",value:"admin"},{label:"Estilista",value:"stylist"}]},null,8,["modelValue"])]),_:1}),a(p,{label:"Sucursal Asignada",name:"branch"},{default:o(()=>[a(z,{modelValue:r.branch_id,"onUpdate:modelValue":e[12]||(e[12]=l=>r.branch_id=l),options:C.value,"option-attribute":"name","value-attribute":"id",placeholder:"Selecciona una sucursal"},null,8,["modelValue","options"])]),_:1}),s("div",ea,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[13]||(e[13]=l=>x.value=!1)}),a(i,{type:"submit",color:"emerald",label:b.value?"Guardar Cambios":"Crear Usuario",loading:M.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(D,{modelValue:y.value,"onUpdate:modelValue":e[19]||(e[19]=l=>y.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",aa,[e[30]||(e[30]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Nueva Sucursal",-1)),a(i,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:e[15]||(e[15]=l=>y.value=!1)})])]),default:o(()=>[s("form",{onSubmit:R(ie,["prevent"]),class:"space-y-4 py-2"},[a(p,{label:"Nombre de Sucursal",name:"name"},{default:o(()=>[a(k,{modelValue:c.name,"onUpdate:modelValue":e[16]||(e[16]=l=>c.name=l),placeholder:"Ej: Centro"},null,8,["modelValue"])]),_:1}),a(p,{label:"Dirección",name:"address"},{default:o(()=>[a(k,{modelValue:c.address,"onUpdate:modelValue":e[17]||(e[17]=l=>c.address=l),icon:"i-heroicons-map-pin"},null,8,["modelValue"])]),_:1}),s("div",la,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[18]||(e[18]=l=>y.value=!1)}),a(i,{type:"submit",color:"emerald",label:"Guardar",loading:P.value},null,8,["loading"])])],32)]),_:1})]),_:1},8,["modelValue"]),a(D,{modelValue:E.value,"onUpdate:modelValue":e[21]||(e[21]=l=>E.value=l)},{default:o(()=>[a(g,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:o(()=>[s("div",ta,[a(re,{name:"i-heroicons-exclamation-triangle",class:"w-5 h-5 text-red-500"}),e[31]||(e[31]=s("h3",{class:"text-base font-semibold text-gray-900 dark:text-white"},"Eliminar Sucursal",-1))])]),footer:o(()=>[s("div",na,[a(i,{color:"gray",variant:"ghost",label:"Cancelar",onClick:e[20]||(e[20]=l=>E.value=!1)}),a(i,{color:"red",label:"Eliminar",icon:"i-heroicons-trash",loading:T.value,onClick:X},null,8,["loading"])])]),default:o(()=>[s("div",sa,[s("p",oa,[e[32]||(e[32]=V(" ¿Estás seguro de que quieres eliminar la sucursal ",-1)),s("strong",null,'"'+m(N.value?.name)+'"',1),e[33]||(e[33]=V("? ",-1))]),e[34]||(e[34]=s("p",{class:"text-xs text-slate-400"}," La sucursal será desactivada. Podrás reactivarla más adelante si lo necesitas. ",-1))])]),_:1})]),_:1},8,["modelValue"])])}}});export{ka as default};
