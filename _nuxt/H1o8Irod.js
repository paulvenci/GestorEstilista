import{f as j,_ as T}from"./BK1iGzOX.js";import{_ as I}from"./CtQBUKAt.js";import{_ as M}from"./Dbnl8vwX.js";import{_ as q,b as F}from"./Bn3KjxKb.js";import{_ as D}from"./DOPkkKYT.js";import{_ as G}from"./eJSVvdZN.js";import{k as O,U as $,a0 as A,a3 as L,f as R,l as W,c as k,a as t,b as n,F as K,K as P,w as i,r as m,o as p,D as U,E as H,t as _,d as S,G as J,W as Q,z as X}from"./C1tViVxN.js";import"./BWX2_Yhy.js";import"./DlAUqK2U.js";import"./kMxVZpd9.js";import"./CDog84tH.js";import"./F2Urmy6C.js";const Y={class:"space-y-6"},Z={class:"flex justify-between items-center"},ee={class:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"},te={class:"flex justify-between items-start"},oe={class:"text-lg font-bold text-slate-900 dark:text-white"},se={class:"text-sm text-slate-500 flex items-center gap-1 mt-1"},ae={class:"flex justify-between items-center mt-4"},ne={class:"flex flex-col"},le={class:"flex gap-2 opacity-100 md:opacity-0 group-hover:opacity-100 transition-opacity"},re={class:"flex items-center justify-between"},ie={class:"text-base font-semibold text-gray-900 dark:text-white"},de={class:"flex items-center justify-between"},ce={class:"flex justify-end gap-3 mt-6"},Se=O({__name:"index",setup(ue){const c=$(),V=A("headerTitle",()=>"Sucursales");V.value="Sucursales";const f=L(),w=m([]),u=m(!1),v=m(!1),d=m(null),a=X({name:"",address:"",phone:"",active:!0}),g=async()=>{console.log("--- fetchBranches START ---");let o=f.value?.id;if(!o){console.log("User ref empty, trying session recovery...");const{data:{session:l}}=await c.auth.getSession();l?.user&&(o=l.user.id,console.log("User recovered from session:",o))}if(!o){console.log("Waiting for user... (UserId still null)");return}console.log("Fetching branches for user (via RLS):",o);const{data:e,error:r}=await c.from("branches").select("*").order("is_main",{ascending:!1}).order("created_at",{ascending:!0});if(r){console.error("Error fetching branches:",r);return}e&&(console.log("Branches loaded:",e.length),w.value=e)};R(f,()=>{console.log("User watch triggered"),g()},{immediate:!0});const C=async()=>{v.value=!0;try{let o=f.value?.id;if(!o){const{data:{session:l}}=await c.auth.getSession();l?.user&&(o=l.user.id)}if(!o)throw new Error("Usuario no autenticado");const{data:e}=await c.from("profiles").select("tenant_id").eq("id",o).single();if(!e)throw new Error("No se encontró perfil de usuario");const r={...a,tenant_id:e.tenant_id};if(d.value){const{error:l}=await c.from("branches").update(r).eq("id",d.value);if(l)throw l}else{const{error:l}=await c.from("branches").insert(r);if(l)throw l}x(),await g(),alert(d.value?"Sucursal actualizada":"Sucursal creada")}catch(o){alert("Error: "+o.message)}finally{v.value=!1}},B=o=>{d.value=o.id,a.name=o.name,a.address=o.address,a.phone=o.phone,a.active=o.active,u.value=!0},x=()=>{u.value=!1,d.value=null,a.name="",a.address="",a.phone="",a.active=!0};return W(()=>{g()}),(o,e)=>{const r=j,l=T,E=I,b=M,h=F,y=q,N=D,z=G;return p(),k("div",Y,[t("div",Z,[e[6]||(e[6]=t("div",{class:"hidden md:block"},[t("h1",{class:"text-3xl font-extrabold text-slate-900 dark:text-white tracking-tight"},"Sucursales"),t("p",{class:"text-slate-500 dark:text-slate-400 mt-1"},"Gestiona las sedes de tu negocio.")],-1)),n(r,{label:"Nueva Sucursal",icon:"i-heroicons-plus",color:"emerald",size:"lg",onClick:e[0]||(e[0]=s=>u.value=!0),class:"shadow-lg shadow-emerald-500/20"})]),t("div",ee,[(p(!0),k(K,null,P(w.value,s=>(p(),U(b,{key:s.id,class:"border-t-4 border-t-emerald-500 relative overflow-hidden group"},{header:i(()=>[t("div",te,[t("div",null,[t("h3",oe,_(s.name),1),t("p",se,[n(l,{name:"i-heroicons-map-pin",class:"w-4 h-4"}),S(" "+_(s.address||"Sin dirección"),1)])]),s.is_main?(p(),U(E,{key:0,color:"blue",variant:"subtle"},{default:i(()=>[...e[7]||(e[7]=[S("Matriz",-1)])]),_:1})):J("",!0)])]),default:i(()=>[t("div",ae,[t("div",ne,[e[8]||(e[8]=t("span",{class:"text-xs text-slate-400 font-medium uppercase"},"Estado",-1)),t("span",{class:H([s.active?"text-emerald-500":"text-red-500","font-bold"])},_(s.active?"Operativa":"Cerrada"),3)]),t("div",le,[n(r,{icon:"i-heroicons-pencil-square",color:"gray",variant:"ghost",size:"xs",onClick:me=>B(s)},null,8,["onClick"])])])]),_:2},1024))),128))]),n(z,{modelValue:u.value,"onUpdate:modelValue":e[5]||(e[5]=s=>u.value=s)},{default:i(()=>[n(b,{ui:{ring:"",divide:"divide-y divide-gray-100 dark:divide-gray-800"}},{header:i(()=>[t("div",re,[t("h3",ie,_(d.value?"Editar Sucursal":"Nueva Sucursal"),1),n(r,{color:"gray",variant:"ghost",icon:"i-heroicons-x-mark-20-solid",class:"-my-1",onClick:x})])]),default:i(()=>[t("form",{onSubmit:Q(C,["prevent"]),class:"space-y-4 py-2"},[n(y,{label:"Nombre",name:"name",required:""},{default:i(()=>[n(h,{modelValue:a.name,"onUpdate:modelValue":e[1]||(e[1]=s=>a.name=s),placeholder:"Ej: Centro, Norte, Plaza",icon:"i-heroicons-building-storefront"},null,8,["modelValue"])]),_:1}),n(y,{label:"Dirección",name:"address"},{default:i(()=>[n(h,{modelValue:a.address,"onUpdate:modelValue":e[2]||(e[2]=s=>a.address=s),icon:"i-heroicons-map-pin"},null,8,["modelValue"])]),_:1}),n(y,{label:"Teléfono",name:"phone"},{default:i(()=>[n(h,{modelValue:a.phone,"onUpdate:modelValue":e[3]||(e[3]=s=>a.phone=s),icon:"i-heroicons-phone"},null,8,["modelValue"])]),_:1}),t("div",de,[e[9]||(e[9]=t("span",{class:"text-sm text-gray-700 dark:text-gray-200"},"Sucursal Operativa",-1)),n(N,{modelValue:a.active,"onUpdate:modelValue":e[4]||(e[4]=s=>a.active=s)},null,8,["modelValue"])]),t("div",ce,[n(r,{color:"gray",variant:"ghost",label:"Cancelar",onClick:x}),n(r,{type:"submit",color:"emerald",label:d.value?"Actualizar":"Crear",loading:v.value},null,8,["label","loading"])])],32)]),_:1})]),_:1},8,["modelValue"])])}}});export{Se as default};
